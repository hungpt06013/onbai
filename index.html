<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ã”n Táº­p BÃ i Há»c - Äa MÃ´n</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="antialiased bg-gradient-to-br from-blue-50 to-green-50 min-h-screen p-6">
<iframe data-testid="embed-iframe" style="border-radius:12px" src="https://open.spotify.com/embed/playlist/37i9dQZF1DX2vYju3i0lNX?utm_source=generator" width="100%" height="152" frameBorder="0" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>
<div style="position:fixed;top:10px;right:10px;z-index:9999;background:rgba(0,0,0,0.8);color:white;padding:10px 20px;border-radius:20px;display:flex;align-items:center;gap:8px;box-shadow:0 4px 12px rgba(0,0,0,0.3);">
  <svg width="12" height="12" style="animation:blink 1.5s infinite;">
    <circle cx="6" cy="6" r="6" fill="#22c55e"/>
  </svg>
  <span style="font-size:14px;font-weight:600;">
    <span id="onlineCount">0</span> ngÆ°á»i Ä‘ang online
  </span>
</div>

<style>
@keyframes blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.3; }
}
</style>

  <!-- SUBJECT SELECTION SCREEN -->
  <div id="subjectScreen" class="min-h-screen flex items-center justify-center">
    <div class="max-w-4xl mx-auto">
      <div class="bg-white rounded-3xl shadow-2xl overflow-hidden">
	  <div class="relative z-50 p-3 rounded-lg border bg-white shadow-lg flex items-center gap-2">
  <input type="checkbox" id="warningToggle" class="w-4 h-4" checked>
  <label for="warningToggle" class="text-sm text-gray-700 cursor-pointer font-bold">
    Cáº£nh bÃ¡o khi ná»™p bÃ i / thoÃ¡t trang / reload
  </label>
</div>
        <div class="bg-gradient-to-r from-blue-600 via-green-600 to-teal-600 p-8 text-white text-center">
          <div class="mb-4">
            <div class="inline-block bg-white/20 rounded-full p-4 backdrop-blur-sm">
              <svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
              </svg>
            </div>
          </div>
          <h1 class="text-4xl font-bold mb-3">Ã”n Táº­p BÃ i Há»c</h1>
          <p class="text-xl text-blue-100">Chá»n mÃ´n há»c Ä‘á»ƒ báº¯t Ä‘áº§u</p>
        </div>

        <div class="p-8">
          <div class="grid md:grid-cols-3 gap-6">
            <button id="selectOnSinh29126" class="group relative overflow-hidden bg-gradient-to-br from-emerald-600 to-emerald-700 text-white p-8 rounded-xl hover:from-emerald-700 hover:to-emerald-800 transition-all transform hover:scale-[1.02] shadow-lg">
              <div class="relative z-10">
                <div class="flex items-center justify-center mb-4">
                  <!-- DNA icon -->
                  <svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                      d="M9 3v1m6-1v1M9 19v1m6-1v1M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6m-6 6h6"/>
                    <circle cx="9" cy="9" r="1" fill="currentColor"/>
                    <circle cx="15" cy="9" r="1" fill="currentColor"/>
                    <circle cx="9" cy="15" r="1" fill="currentColor"/>
                    <circle cx="15" cy="15" r="1" fill="currentColor"/>
                  </svg>
                </div>
                <h3 class="text-2xl font-bold mb-2">Ã”n Sinh 29.1.26</h3>
                <p class="text-emerald-100 text-sm">Ã”n Sinh 29.1.26</p>
                <div class="mt-4 text-xs bg-white/20 rounded-full px-3 py-1 w-fit mx-auto">17 cÃ¢u há»i</div>
              </div>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODE SELECTION SCREEN -->
  <div id="modeScreen" class="hidden min-h-screen flex items-center justify-center">
    <div class="max-w-4xl mx-auto">
      <div class="bg-white rounded-3xl shadow-2xl overflow-hidden">
        <div class="bg-gradient-to-r from-blue-600 via-green-600 to-teal-600 p-8 text-white text-center relative">

          <button id="backToSubject" class="absolute top-4 left-4 z-20 flex items-center gap-2 text-white hover:text-blue-100 transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            <span class="font-medium">Chá»n mÃ´n khÃ¡c</span>
          </button>
	  
          <div class="mb-4">
            <div class="inline-block bg-white/20 rounded-full p-4 backdrop-blur-sm">
              <svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
            </div>
          </div>

          <h1 class="text-4xl font-bold mb-3" id="subjectTitle"></h1>
          <p class="text-xl text-blue-100">Chá»n cháº¿ Ä‘á»™ lÃ m bÃ i</p>
        </div>

        <div class="p-8">
          <div class="grid md:grid-cols-2 gap-4">
            <button id="startFull" class="group relative overflow-hidden bg-gradient-to-br from-blue-600 to-blue-700 text-white p-6 rounded-xl hover:from-blue-700 hover:to-blue-800 transition-all transform hover:scale-[1.02] shadow-lg">
              <div class="relative z-10">
                <div class="flex items-center justify-center mb-3">
                  <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2" />
                  </svg>
                </div>
                <h3 class="text-xl font-bold mb-2">BÃ i Test Äáº§y Äá»§</h3>
                <p class="text-blue-100 text-sm mb-3" id="fullModeDesc"></p>
                <div class="flex items-center justify-center gap-2 text-xs bg-white/20 rounded-full px-3 py-1 w-fit mx-auto">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <span>KhÃ´ng giá»›i háº¡n thá»i gian</span>
                </div>
              </div>
            </button>

            <button id="startRandom" class="group relative overflow-hidden bg-gradient-to-br from-green-600 to-green-700 text-white p-6 rounded-xl hover:from-green-700 hover:to-green-800 transition-all transform hover:scale-[1.02] shadow-lg">
              <div class="relative z-10">
                <div class="flex items-center justify-center mb-3">
                  <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581" />
                  </svg>
                </div>
                <h3 class="text-xl font-bold mb-2">Luyá»‡n Táº­p Ngáº«u NhiÃªn</h3>
                <p class="text-green-100 text-sm mb-3">Má»—i láº§n 1 cÃ¢u random</p>
                <div class="flex items-center justify-center gap-2 text-xs bg-white/20 rounded-full px-3 py-1 w-fit mx-auto">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                  </svg>
                  <span>KhÃ´ng giá»›i háº¡n</span>
                </div>
              </div>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- QUIZ SCREEN -->
  <div id="quizScreen" class="hidden min-h-screen flex items-start justify-center pt-12">
    <div class="max-w-3xl mx-auto w-full">
      <div class="bg-white rounded-2xl shadow-xl p-8">
        <div class="flex justify-between items-center mb-6">
          <button id="backHome" class="flex items-center gap-2 text-gray-600 hover:text-gray-800 transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            <span class="font-medium">Trang chá»§</span>
          </button>

          <div class="flex items-center gap-3">
            <button id="btnRestart" class="flex items-center gap-2 px-4 py-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors border border-blue-200" title="LÃ m láº¡i bÃ i test">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12a9 9 0 0114.32-6.32L21 6m0 0v-4m0 4h-4"/>
              </svg>
              <span class="font-medium hidden sm:inline">LÃ m láº¡i</span>
            </button>
            <div class="flex items-center gap-4 border-l pl-3">
              <div id="countInfo" class="text-sm font-semibold text-gray-500"></div>
              <div id="scoreInfo" class="text-lg font-bold text-blue-600"></div>
            </div>
          </div>
        </div>

        <div id="progressWrap" class="mb-6">
          <div id="progressBar" class="w-full bg-gray-200 rounded-full h-2">
            <div id="progressFill" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width:0%"></div>
          </div>
        </div>

        <div id="quizContent"></div>

        <div class="flex gap-3 mt-6">
          <button id="btnSubmit" class="flex-1 py-3 rounded-lg font-semibold transition-colors bg-gray-300 text-gray-500 cursor-not-allowed" disabled>Kiá»ƒm tra Ä‘Ã¡p Ã¡n / Ná»™p bÃ i</button>
          <button id="btnNext" class="hidden flex-1 bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition-colors">CÃ¢u tiáº¿p theo â†’</button>
        </div>
      </div>
    </div>
  </div>

  <!-- RESULT SCREEN -->
  <div id="resultScreen" class="hidden min-h-screen p-6">
    <div class="max-w-2xl mx-auto">
      <div class="bg-white rounded-2xl shadow-xl p-8 text-center">
        <div id="trophyWrap" class="w-20 h-20 mx-auto text-yellow-500 mb-4">
          <svg viewBox="0 0 24 24" class="w-20 h-20 inline-block" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 21h8M12 3v4m5 0a5 5 0 01-10 0"/>
          </svg>
        </div>
        <h2 class="text-3xl font-bold text-gray-800 mb-4">HoÃ n thÃ nh bÃ i kiá»ƒm tra! ğŸ‰</h2>
        <div id="resultScoreLarge" class="text-6xl font-bold text-blue-600 mb-2">0/0</div>
        <p id="resultPercent" class="text-xl text-gray-600 mb-6">Äiá»ƒm sá»‘: 0%</p>

        <p id="resultRemark" class="text-lg font-semibold mb-6"></p>

        <div class="flex flex-col gap-3 mt-8">
          <button id="resultRestart" class="flex items-center justify-center gap-2 w-full bg-blue-600 text-white px-8 py-4 rounded-lg hover:bg-blue-700 transition-colors font-semibold text-lg">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h4V6m0 0a9 9 0 1118 0M21 14v6h-6"/>
            </svg>
            LÃ m láº¡i bÃ i kiá»ƒm tra
          </button>

          <button id="resultHome" class="flex items-center justify-center gap-2 w-full bg-gray-600 text-white px-8 py-4 rounded-lg hover:bg-gray-700 transition-colors font-semibold text-lg">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3"/>
            </svg>
            Vá» trang chá»§
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // === DATA ===
    const subjectData = {
      onsinh29126: {
        fullName: 'Ã”n Sinh 29.1.26',
        questions: [
          {
            type: 'mcq',
            q: 'Sinh trÆ°á»Ÿng lÃ ',
            o: [
              'sá»± tÄƒng lÃªn vá» kÃ­ch thÆ°á»›c cÆ¡ thá»ƒ do tÄƒng lÃªn vá» kÃ­ch thÆ°á»›c táº¿ bÃ o.',
              'sá»± tÄƒng lÃªn vá» khá»‘i lÆ°á»£ng cÆ¡ thá»ƒ do tÄƒng lÃªn vá» sá»‘ lÆ°á»£ng táº¿ bÃ o.',
              'sá»± tÄƒng lÃªn vá» kÃ­ch thÆ°á»›c vÃ  khá»‘i lÆ°á»£ng cÆ¡ thá»ƒ do tÄƒng lÃªn vá» kÃ­ch thÆ°á»›c táº¿ bÃ o.',
              'sá»± tÄƒng lÃªn vá» kÃ­ch thÆ°á»›c vÃ  khá»‘i lÆ°á»£ng cÆ¡ thá»ƒ do tÄƒng lÃªn vá» sá»‘ lÆ°á»£ng vÃ  kÃ­ch thÆ°á»›c táº¿ bÃ o.'
            ],
            c: 3
          },
          {
            type: 'mcq',
            q: 'PhÃ¡t triá»ƒn lÃ ',
            o: [
              'nhá»¯ng biáº¿n Ä‘á»•i cá»§a cÆ¡ thá»ƒ sinh váº­t bao gá»“m ba quÃ¡ trÃ¬nh liÃªn quan máº­t thiáº¿t vá»›i nhau lÃ  sinh trÆ°á»Ÿng, phÃ¢n hÃ³a táº¿ bÃ o vÃ  phÃ¡t sinh hÃ¬nh thÃ¡i cÃ¡c cÆ¡ quan cá»§a cÆ¡ thá»ƒ.',
              'sá»± tÄƒng lÃªn vá» kÃ­ch thÆ°á»›c vÃ  khá»‘i lÆ°á»£ng cÆ¡ thá»ƒ do tÄƒng lÃªn vá» sá»‘ lÆ°á»£ng vÃ  kÃ­ch thÆ°á»›c táº¿ bÃ o.',
              'nhá»¯ng biáº¿n Ä‘á»•i cá»§a cÆ¡ thá»ƒ sinh váº­t dÆ°á»›i tÃ¡c Ä‘á»™ng trá»±c tiáº¿p cá»§a mÃ´i trÆ°á»ng sá»‘ng mÃ  khÃ´ng liÃªn quan Ä‘áº¿n biáº¿n Ä‘á»•i váº­t cháº¥t di truyá»n.',
              'nhá»¯ng biáº¿n Ä‘á»•i Ä‘á»™t ngá»™t cá»§a cÆ¡ thá»ƒ sinh váº­t do biáº¿n Ä‘á»•i váº­t cháº¥t di truyá»n mÃ  khÃ´ng liÃªn quan Ä‘áº¿n biáº¿n Ä‘á»•i Ä‘iá»u kiá»‡n mÃ´i trÆ°á»ng sá»‘ng.'
            ],
            c: 0
          },
          {
            type: 'mcq',
            q: 'Cho báº£ng thÃ´ng tin sau:<table class="border-collapse border border-gray-400"><thead><tr><th class="border border-gray-300 p-2">QuÃ¡ trÃ¬nh</th><th class="border border-gray-300 p-2">Biá»ƒu hiá»‡n</th></tr></thead><tbody><tr><td class="border border-gray-300 p-2">(1) Sinh trÆ°á»Ÿng<br>(2) PhÃ¡t triá»ƒn</td><td class="border border-gray-300 p-2">(a) Thá»ƒ trá»ng lá»£n con tá»« 5kg tÄƒng 8kg.<br>(b) KÃ­ch thÆ°á»›c lÃ¡ tÄƒng lÃªn.<br>(c) Háº¡t giá»‘ng náº£y máº§m.<br>(d) CÃ¢y bÆ°á»Ÿi ra lÃ¡ non.<br>(e) Trá»©ng gÃ  ná»Ÿ thÃ nh gÃ  con.</td></tr></tbody></table>CaÌch ghÃ©p ná»‘i phÃ¹ há»£p laÌ€',
            o: [
              '1-a,b; 2-c,d,e.',
              '1-a,c; 2-b,d,e.',
              '1-a,d; 2-b,c,e.',
              '1-a,e; 2-b,c,d.'
            ],
            c: 0
          },
          {
            type: 'mcq',
            q: 'PhaÌt biÃªÌ‰u naÌ€o sau Ä‘Ã¢y laÌ€ Ä‘uÌng khi noÌi vÃªÌ€ mÃ´Ìi quan hÃªÌ£ giÆ°Ìƒa sinh trÆ°Æ¡Ì‰ng vaÌ€ phaÌt triÃªÌ‰n?',
            o: [
              'Sinh trÆ°Æ¡Ì‰ng vaÌ€ phaÌt triÃªÌ‰n laÌ€ hai quaÌ triÌ€nh coÌ mÃ´Ìi quan hÃªÌ£ Ä‘Ã´Ì£c lÃ¢Ì£p vÆ¡Ìi nhau; sinh trÆ°Æ¡Ì‰ng luÃ´n diÃªÌƒn ra trÆ°Æ¡Ìc phaÌt triÃªÌ‰n.',
              'Sinh trÆ°Æ¡Ì‰ng vaÌ€ phaÌt triÃªÌ‰n laÌ€ hai quaÌ triÌ€nh coÌ mÃ´Ìi quan hÃªÌ£ Ä‘Ã´Ì£c lÃ¢Ì£p vÆ¡Ìi nhau; phaÌt triÃªÌ‰n luÃ´n diÃªÌƒn ra trÆ°Æ¡Ìc sinh trÆ°Æ¡Ì‰ng.',
              'Sinh trÆ°Æ¡Ì‰ng vaÌ€ phaÌt triÃªÌ‰n laÌ€ hai quaÌ triÌ€nh coÌ mÃ´Ìi quan hÃªÌ£ mÃ¢Ì£t thiÃªÌt vÆ¡Ìi nhau; sinh trÆ°Æ¡Ì‰ng taÌ£o tiÃªÌ€n Ä‘ÃªÌ€ cho phaÌt triÃªÌ‰n coÌ€n phaÌt triÃªÌ‰n seÌƒ thuÌc Ä‘Ã¢Ì‰y sinh trÆ°Æ¡Ì‰ng.',
              'Sinh trÆ°Æ¡Ì‰ng vaÌ€ phaÌt triÃªÌ‰n laÌ€ hai quaÌ triÌ€nh coÌ mÃ´Ìi quan hÃªÌ£ mÃ¢Ì£t thiÃªÌt vÆ¡Ìi nhau; phaÌt triÃªÌ‰n taÌ£o tiÃªÌ€n Ä‘ÃªÌ€ cho sinh trÆ°Æ¡Ì‰ng coÌ€n sinh trÆ°Æ¡Ì‰ng seÌƒ thuÌc Ä‘Ã¢Ì‰y phaÌt triÃªÌ‰n.'
            ],
            c: 2
          },
          {
            type: 'mcq',
            q: 'CÆ¡ sá»Ÿ cho sá»± sinh trÆ°á»Ÿng cá»§a thá»±c váº­t lÃ  sá»± phÃ¢n chia cá»§a cÃ¡c táº¿ bÃ o thuÃ´Ì£c',
            o: [
              'mÃ´ má»m.',
              'mÃ´ xá»‘p.',
              'mÃ´ dáº«n.',
              'mÃ´ phÃ¢n sinh.'
            ],
            c: 3
          },
          {
            type: 'mcq',
            q: 'MÃ´ phÃ¢n sinh lÃ ',
            o: [
              'nhÃ³m cÃ¡c táº¿ bÃ o cÃ³ kháº£ nÄƒng phÃ¢n chia, giÃºp cho thá»±c váº­t tÄƒng trÆ°á»Ÿng vá» kÃ­ch thÆ°á»›c.',
              'nhÃ³m cÃ¡c táº¿ bÃ o coÌ khaÌ‰ nÄƒng caÌ‰m Æ°Ìng, giÃºp cho thá»±c váº­t tÄƒng trÆ°á»Ÿng vá» kÃ­ch thÆ°á»›c.',
              'nhÃ³m cÃ¡c táº¿ bÃ o coÌ khaÌ‰ nÄƒng biÃªÌ£t hoÌa, giÃºp cho thá»±c váº­t tÄƒng trÆ°á»Ÿng vá» kÃ­ch thÆ°á»›c.',
              'nhÃ³m cÃ¡c táº¿ bÃ o coÌ khaÌ‰ nÄƒng phaÌ‰n biÃªÌ£t hoÌa, giÃºp cho thá»±c váº­t tÄƒng trÆ°á»Ÿng vá» kÃ­ch thÆ°á»›c.'
            ],
            c: 0
          },
          {
            type: 'mcq',
            q: 'CÃ¢y MÃ´Ì£t laÌ mÃ¢Ì€m khÃ´ng coÌ khaÌ‰ nÄƒng tÄƒng kiÌch thÆ°Æ¡Ìc Ä‘Æ°Æ¡Ì€ng kiÌnh thÃ¢n liÃªn tuÌ£c nhÆ° cÃ¢y Hai laÌ mÃ¢Ì€m laÌ€ do cÃ¢y MÃ´Ì£t laÌ mÃ¢Ì€m khÃ´ng coÌ',
            o: [
              'mÃ´ phÃ¢n sinh.',
              'mÃ´ phÃ¢n sinh Ä‘iÌ‰nh.',
              'mÃ´ phÃ¢n sinh loÌng.',
              'mÃ´ phÃ¢n sinh bÃªn.'
            ],
            c: 3
          },
          {
            type: 'mcq',
            q: 'Má»—i sinh váº­t trong quÃ¡ trÃ¬nh sá»‘ng Ä‘á»u tráº£i qua cÃ¡c giai Ä‘oáº¡n sinh trÆ°á»Ÿng vÃ  phÃ¡t triá»ƒn khÃ¡c nhau goÌ£i laÌ€',
            o: [
              'voÌ€ng Ä‘Æ¡Ì€i.',
              'quaÌ triÌ€nh sinh trÆ°Æ¡Ì‰ng.',
              'quaÌ triÌ€nh phaÌt triÃªÌ‰n.',
              'quaÌ triÌ€nh biÃªÌn Ä‘á»•i.'
            ],
            c: 0
          },
          {
            type: 'mcq',
            q: 'VoÌ€ng Ä‘Æ¡Ì€i cuÌ‰a ÃªÌch traÌ‰i qua caÌc giai Ä‘oaÌ£n lÃ¢Ì€n lÆ°Æ¡Ì£t laÌ€',
            o: [
              'phÃ´i â†’ trÆ°Ìng â†’ noÌ€ng noÌ£c â†’ noÌ€ng noÌ£c 2 chÃ¢n â†’ noÌ€ng noÌ£c 4 chÃ¢n â†’ ÃªÌch con â†’ ÃªÌch trÆ°Æ¡Ì‰ng thaÌ€nh.',
              'trÆ°Ìng â†’ phÃ´i â†’ noÌ€ng noÌ£c â†’ noÌ€ng noÌ£c 2 chÃ¢n â†’ noÌ€ng noÌ£c 4 chÃ¢n â†’ ÃªÌch con â†’ ÃªÌch trÆ°Æ¡Ì‰ng thaÌ€nh.',
              'phÃ´i â†’ trÆ°Ìng â†’ noÌ€ng noÌ£c â†’ noÌ€ng noÌ£c 4 chÃ¢n â†’ noÌ€ng noÌ£c 2 chÃ¢n â†’ ÃªÌch con â†’ ÃªÌch trÆ°Æ¡Ì‰ng thaÌ€nh.',
              'trÆ°Ìng â†’ phÃ´i â†’ noÌ€ng noÌ£c â†’ noÌ€ng noÌ£c 4 chÃ¢n â†’ noÌ€ng noÌ£c 2 chÃ¢n â†’ ÃªÌch con â†’ ÃªÌch trÆ°Æ¡Ì‰ng thaÌ€nh.'
            ],
            c: 1
          },
          {
            type: 'mcq',
            q: 'Quan saÌt voÌ€ng Ä‘Æ¡Ì€i cuÌ‰a ÃªÌch vaÌ€ cuÌ‰a gaÌ€ dÆ°Æ¡Ìi Ä‘Ã¢y: // ChÃ¨n link image1.png á»Ÿ Ä‘Ã¢y (vÃ²ng Ä‘á»i áº¿ch) // ChÃ¨n link image2.png á»Ÿ Ä‘Ã¢y (vÃ²ng Ä‘á»i gÃ )<br>ÄiÃªÌ‰m khaÌc nhau cÆ¡ baÌ‰n trong voÌ€ng Ä‘Æ¡Ì€i cuÌ‰a gaÌ€ so vÆ¡Ìi ÃªÌch laÌ€',
            o: [
              'xaÌ‰y ra nhiÃªÌ€u sÆ°Ì£ biÃªÌn Ä‘Ã´Ì‰i Ä‘Ã´Ì£t ngÃ´Ì£t vÃªÌ€ hiÌ€nh thaÌi.',
              'khÃ´ng xaÌ‰y ra nhiÃªÌ€u biÃªÌn Ä‘Ã´Ì‰i Ä‘Ã´Ì£t ngÃ´Ì£t vÃªÌ€ hiÌ€nh thaÌi.',
              'coÌ giai Ä‘oaÌ£n hÆ¡Ì£p tÆ°Ì‰ phaÌt triÃªÌ‰n thaÌ€nh phÃ´i diÃªÌƒn ra trong trÆ°Ìng Ä‘aÌƒ thuÌ£ tinh.',
              'khÃ´ng coÌ giai Ä‘oaÌ£n hÆ¡Ì£p tÆ°Ì‰ phaÌt triÃªÌ‰n thaÌ€nh phÃ´i diÃªÌƒn ra trong trÆ°Ìng Ä‘aÌƒ thuÌ£ tinh.'
            ],
            c: 1
          },
          {
            type: 'mcq',
            q: 'VoÌ€ng Ä‘Æ¡Ì€i cuÌ‰a bÆ°á»›m traÌ‰i qua caÌc giai Ä‘oaÌ£n lÃ¢Ì€n lÆ°Æ¡Ì£t laÌ€',
            o: [
              'trá»©ng â†’ sÃ¢u bÆ°á»›m â†’ kÃ©n â†’ bÆ°á»›m trÆ°á»Ÿng thÃ nh',
              'trá»©ng â†’ kÃ©n â†’ sÃ¢u bÆ°á»›m â†’ bÆ°á»›m trÆ°á»Ÿng thÃ nh',
              'kÃ©n â†’ trÆ°Ìng â†’ sÃ¢u bÆ°á»›m â†’ bÆ°á»›m trÆ°á»Ÿng thÃ nh',
              'kÃ©n â†’ sÃ¢u bÆ°á»›m â†’ trÆ°Ìng â†’ bÆ°á»›m trÆ°á»Ÿng thÃ nh'
            ],
            c: 0
          },
          {
            type: 'mcq',
            q: 'Sinh trÆ°á»Ÿng hay phÃ¡t triá»ƒn quan trá»ng hÆ¡n',
            o: [
              'Sinh trÆ°á»Ÿng',
              'PhÃ¡t triá»ƒn',
              'Cáº£ 2 Ä‘á»u quan trá»ng nhÆ° nhau',
              'Cáº£ 2 Ä‘á»u khÃ´ng quan trá»ng'
            ],
            c: 2
          },
          {
            type: 'mcq',
            q: 'Cho báº£ng thÃ´ng tin sau:<table class="border-collapse border border-gray-400"><thead><tr><th class="border border-gray-300 p-2">QuÃ¡ trÃ¬nh</th><th class="border border-gray-300 p-2">Biá»ƒu hiá»‡n</th></tr></thead><tbody><tr><td class="border border-gray-300 p-2">(1) Sinh trÆ°á»Ÿng<br>(2) PhÃ¡t triá»ƒn</td><td class="border border-gray-300 p-2">(a) Sau má»™t nÄƒm, em há»c sinh lá»›p 1 cao thÃªm 10 cm.<br>(b) Háº¡t Ä‘áº­u ngÃ¢m nÆ°á»›c lÃ¢u ná»Ÿ to hÆ¡n lÃºc Ä‘áº§u.<br>(c) Háº¡t Ä‘á»— náº£y máº§m.<br>(d) CÃ¢y bÆ°á»Ÿi ra hoa.<br>(e) Trá»©ng gÃ  ná»Ÿ thÃ nh gÃ  con.</td></tr></tbody></table>CaÌch ghÃ©p ná»‘i phÃ¹ há»£p laÌ€',
            o: [
              '1-a,b; 2-c,d,e.',
              '1-a,c; 2-b,d,e.',
              '1-a,d; 2-b,c,e.',
              '1-a,e; 2-b,c,d.'
            ],
            c: 0
          },
          {
            type: 'mcq',
            q: 'MÃ´ phÃ¢n sinh Ä‘á»‰nh náº±m á»Ÿ vá»‹ trÃ­ Ä‘á»‰nh cá»§a..., cÃ³ chá»©c nÄƒng...?',
            o: [
              'rá»… vÃ  thÃ¢n - giÃºp cÃ¢y sinh trÆ°á»Ÿng vá» chiá»u cao',
              'lÃ¡ vÃ  hoa - giÃºp cÃ¢y sinh trÆ°á»Ÿng vá» chiá»u ngang',
              'thÃ¢n vÃ  cÃ nh - giÃºp cÃ¢y phÃ¡t triá»ƒn thÃªm lÃ¡',
              'rá»… vÃ  lÃ¡ - giÃºp cÃ¢y háº¥p thá»¥ dinh dÆ°á»¡ng'
            ],
            c: 0
          },
          {
            type: 'mcq',
            q: 'MÃ´ phÃ¢n sinh bÃªn phÃ¢n bá»‘ ..., cÃ³ chá»©c nÄƒng ...',
            o: [
              'á»Ÿ vÃ¹ng Ä‘á»‰nh cá»§a thÃ¢n vÃ  rá»… táº¡o thÃ nh cÃ¡c mÃ´ phÃ¢n sinh ngá»n - lÃ m tÄƒng chiá»u dÃ i cá»§a thÃ¢n vÃ  rá»… thÃ´ng qua sinh trÆ°á»Ÿng chiá»u dá»c liÃªn tá»¥c',
              'theo hÃ¬nh trá»¥ vÃ  hÆ°á»›ng ra phÃ­a ngoÃ i cá»§a thÃ¢n - lÃ m tÄƒng Ä‘á»™ dÃ y cá»§a thÃ¢n, rá»…, cÃ nh.',
              'á»Ÿ cÃ¡c máº¯t chá»“i bÃªn vÃ  chá»“i ngá»n dá»c theo thÃ¢n - táº¡o ra cÃ¡c cÆ¡ quan má»›i nhÆ° lÃ¡, hoa, quáº£ vÃ  phÃ¢n nhÃ¡nh cho cÃ¢y',
              'giá»¯a mÃ´ gá»— vÃ  mÃ´ rÃ¢y theo chiá»u xuyÃªn tÃ¢m cá»§a thÃ¢n - váº­n chuyá»ƒn nÆ°á»›c, cháº¥t khoÃ¡ng vÃ  sáº£n pháº©m quang há»£p giá»¯a cÃ¡c bá»™ pháº­n cá»§a cÃ¢y'
            ],
            c: 1
          },
          {
            type: 'mcq',
            q: 'á» cÃ¢y Hai lÃ¡ máº§m, mÃ´ phÃ¢n sinh gá»“m cÃ³ gÃ¬?',
            o: [
              'mÃ´ phÃ¢n sinh Ä‘á»‰nh vÃ  mÃ´ phÃ¢n sinh giá»¯a',
              'mÃ´ phÃ¢n sinh Ä‘á»‰nh vÃ  mÃ´ phÃ¢n sinh rá»…',
              'mÃ´ phÃ¢n sinh Ä‘á»‰nh vÃ  mÃ´ phÃ¢n sinh bÃªn',
              'mÃ´ phÃ¢n sinh thá»© bÃªn vÃ  mÃ´ phÃ¢n sinh giá»¯a'
            ],
            c: 2
          },
          {
            type: 'mcq',
            q: 'Cho cÃ¡c bá»™ pháº­n sau:<br>(1) Äá»‰nh rá»…<br>(2) ThÃ¢n<br>(3) Chá»“i nÃ¡ch<br>(4) Chá»“i Ä‘á»‰nh<br>(5) Hoa<br>(6) LÃ¡<br>MÃ´ phÃ¢n sinh Ä‘á»‰nh khÃ´ng cÃ³ á»Ÿ',
            o: [
              '(1), (2), (3).',
              '(2), (3), (4).',
              '(3), (4), (5).',
              '(2), (5), (6).'
            ],
            c: 3
          }
        ]
      }
    };

    let currentSubject = null;
    let quizMode = null;
    let quizStarted = false;
    let quizCompleted = false;
    let shuffledQuestions = [];
    let score = 0; // will hold total points (float)

    let userAnswers = []; // for each question:
    // - for mcq: userAnswers[i] = selectedIndex|null
    // - for tf: userAnswers[i] = [true/false|null, true/false|null, ...] (length 4)

    // UI refs
    const subjectScreen = document.getElementById('subjectScreen');
    const modeScreen = document.getElementById('modeScreen');
    const quizScreen = document.getElementById('quizScreen');
    const resultScreen = document.getElementById('resultScreen');

    const backToSubject = document.getElementById('backToSubject');
    const subjectTitle = document.getElementById('subjectTitle');
    const fullModeDesc = document.getElementById('fullModeDesc');

    const startFullBtn = document.getElementById('startFull');
    const startRandomBtn = document.getElementById('startRandom');

    const backHomeBtn = document.getElementById('backHome');
    const btnRestart = document.getElementById('btnRestart');
    const countInfo = document.getElementById('countInfo');
    const scoreInfo = document.getElementById('scoreInfo');
    const progressFill = document.getElementById('progressFill');
    const quizContent = document.getElementById('quizContent');
    const btnSubmit = document.getElementById('btnSubmit');
    const btnNext = document.getElementById('btnNext');

    const resultScoreLarge = document.getElementById('resultScoreLarge');
    const resultPercent = document.getElementById('resultPercent');
    const resultRemark = document.getElementById('resultRemark');
    const resultRestart = document.getElementById('resultRestart');
    const resultHome = document.getElementById('resultHome');

    // helpers
    function shuffleArray(array) {
      const arr = array.slice();
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function shuffleOptionsForMCQ(question) {
      // returns a copy (qObj) with shuffled o and updated c
      if (question.type !== 'mcq') return JSON.parse(JSON.stringify(question));
      const opts = question.o.map((t, idx) => ({ t, idx }));
      const sh = shuffleArray(opts);
      const newQ = {
        type: 'mcq',
        q: question.q,
        o: sh.map(x => x.t),
        c: sh.findIndex(x => x.idx === question.c)
      };
      return newQ;
    }

    // initialize quiz
    function initializeQuiz(mode = 'full') {
      const allQ = subjectData[currentSubject].questions;
      if (mode === 'full') {
        const shuffled = shuffleArray(allQ).map(q => {
          if (q.type === 'mcq') return shuffleOptionsForMCQ(q);
          else return JSON.parse(JSON.stringify(q)); // tf unchanged
        });
        shuffledQuestions = shuffled;
        userAnswers = shuffledQuestions.map(q => q.type === 'mcq' ? null : [null, null, null, null]);
      } else {
        if (allQ.length === 0) {
          alert('KhÃ´ng cÃ³ cÃ¢u há»i.');
          return;
        }
        const q = allQ[Math.floor(Math.random() * allQ.length)];
        shuffledQuestions = (q.type === 'mcq') ? [shuffleOptionsForMCQ(q)] : [JSON.parse(JSON.stringify(q))];
        userAnswers = [ (shuffledQuestions[0].type === 'mcq') ? null : [null,null,null,null] ];
      }
      quizMode = mode;
      quizStarted = true;
      quizCompleted = false;
      score = 0;
      renderQuiz();
    }

    // Render quiz screen
    function renderQuiz() {
      if (!currentSubject) {
        subjectScreen.classList.remove('hidden');
        modeScreen.classList.add('hidden');
        quizScreen.classList.add('hidden');
        resultScreen.classList.add('hidden');
        return;
      }
      if (!quizStarted) {
        subjectScreen.classList.add('hidden');
        modeScreen.classList.remove('hidden');
        quizScreen.classList.add('hidden');
        resultScreen.classList.add('hidden');
        return;
      }
      subjectScreen.classList.add('hidden');
      modeScreen.classList.add('hidden');
      quizScreen.classList.remove('hidden');
      resultScreen.classList.add('hidden');

      // header info
      const totalQuestions = shuffledQuestions.length;
      if (quizMode === 'full') {
        countInfo.textContent = `Tá»•ng ${totalQuestions} cÃ¢u`;
        const answeredCount = shuffledQuestions.reduce((acc, q, i) => {
          if (q.type === 'mcq') return acc + (userAnswers[i] !== null ? 1 : 0);
          else {
            return acc + (userAnswers[i].some(x => x !== null) ? 1 : 0);
          }
        }, 0);
        scoreInfo.textContent = `ÄÃ£ tráº£ lá»i: ${answeredCount}/${totalQuestions}`;
        const pct = Math.round((answeredCount/Math.max(1,totalQuestions))*100);
        progressFill.style.width = pct + '%';
      } else {
        if (shuffledQuestions[0].type === 'mcq') {
          scoreInfo.textContent = `ÄÃ£ tráº£ lá»i: ${userAnswers[0] !== null ? 1 : 0}/1`;
        } else {
          scoreInfo.textContent = `ÄÃ£ tráº£ lá»i: ${userAnswers[0].some(x=>x!==null) ? 1 : 0}/1`;
        }
        progressFill.style.width = '0%';
      }

      // render content
      quizContent.innerHTML = '';
      btnRestart.textContent = (quizMode === 'random') ? 'CÃ¢u khÃ¡c' : 'LÃ m láº¡i';

      if (quizMode === 'full') {
        // show all questions
        shuffledQuestions.forEach((q, qi) => {
          const qWrap = document.createElement('div');
          qWrap.className = 'mb-6 pb-4 border-b';

          const qTitle = document.createElement('h3');
          qTitle.className = 'text-lg font-semibold mb-3';
          qTitle.innerHTML = `CÃ¢u ${qi+1}. ${q.q}`;

          qWrap.appendChild(qTitle);

          if (q.type === 'mcq') {
            const opts = document.createElement('div');
            opts.className = 'space-y-2';
            q.o.forEach((opt, oi) => {
              const btn = document.createElement('button');
              btn.type = 'button';
              btn.className = 'w-full text-left p-3 rounded-lg border-2 border-gray-200 transition-all flex items-center justify-between';
              btn.dataset.qi = qi; btn.dataset.oi = oi;
              btn.innerHTML = `<span class="font-medium text-gray-800">${opt}</span><span class="icon-area"></span>`;

              if (userAnswers[qi] === oi) {
                btn.classList.add('border-blue-500', 'bg-blue-50');
              }

              btn.addEventListener('click', () => {
                if (userAnswers[qi] === oi) {
                  userAnswers[qi] = null;
                  btn.classList.remove('border-blue-500', 'bg-blue-50');
                } else {
                  userAnswers[qi] = oi;
                  opts.querySelectorAll('button').forEach(b => b.classList.remove('border-blue-500', 'bg-blue-50'));
                  btn.classList.add('border-blue-500', 'bg-blue-50');
                }
                const answeredCount = shuffledQuestions.reduce((acc, q2, i2) => {
                  if (q2.type === 'mcq') return acc + (userAnswers[i2] !== null ? 1 : 0);
                  else return acc + (userAnswers[i2].some(x=>x!==null) ? 1 : 0);
                }, 0);
                scoreInfo.textContent = `ÄÃ£ tráº£ lá»i: ${answeredCount}/${shuffledQuestions.length}`;
                setSubmitState(answeredCount > 0, 'Ná»™p bÃ i');
              });

              opts.appendChild(btn);
            });
            qWrap.appendChild(opts);
          } else if (q.type === 'tf') {
            const opts = document.createElement('div');
            opts.className = 'space-y-2';
            q.statements.forEach((stmt, sidx) => {
              const row = document.createElement('div');
              row.className = 'flex items-center gap-3';

              const stmtDiv = document.createElement('div');
              stmtDiv.className = 'flex-1 p-3 rounded-lg border border-gray-200';
              stmtDiv.innerHTML = `<div class="font-medium text-gray-800">${stmt}</div>`;

              row.appendChild(stmtDiv);

              const btnTrue = document.createElement('button');
              btnTrue.type = 'button';
              btnTrue.className = 'px-3 py-2 rounded-lg border border-gray-200 mr-2';
              btnTrue.textContent = 'ÄÃšNG';
              const btnFalse = document.createElement('button');
              btnFalse.type = 'button';
              btnFalse.className = 'px-3 py-2 rounded-lg border border-gray-200';
              btnFalse.textContent = 'SAI';

              const val = userAnswers[qi][sidx];
              if (val === true) { btnTrue.classList.add('bg-blue-50','border-blue-500'); }
              else if (val === false) { btnFalse.classList.add('bg-blue-50','border-blue-500'); }

              btnTrue.addEventListener('click', () => {
                if (userAnswers[qi][sidx] === true) {
                  userAnswers[qi][sidx] = null;
                  btnTrue.classList.remove('bg-blue-50','border-blue-500');
                } else {
                  userAnswers[qi][sidx] = true;
                  btnTrue.classList.add('bg-blue-50','border-blue-500');
                  btnFalse.classList.remove('bg-blue-50','border-blue-500');
                }
                const answeredCount = shuffledQuestions.reduce((acc, q2, i2) => {
                  if (q2.type === 'mcq') return acc + (userAnswers[i2] !== null ? 1 : 0);
                  else return acc + (userAnswers[i2].some(x=>x!==null) ? 1 : 0);
                }, 0);
                scoreInfo.textContent = `ÄÃ£ tráº£ lá»i: ${answeredCount}/${shuffledQuestions.length}`;
                setSubmitState(answeredCount > 0, 'Ná»™p bÃ i');
              });

              btnFalse.addEventListener('click', () => {
                if (userAnswers[qi][sidx] === false) {
                  userAnswers[qi][sidx] = null;
                  btnFalse.classList.remove('bg-blue-50','border-blue-500');
                } else {
                  userAnswers[qi][sidx] = false;
                  btnFalse.classList.add('bg-blue-50','border-blue-500');
                  btnTrue.classList.remove('bg-blue-50','border-blue-500');
                }
                const answeredCount = shuffledQuestions.reduce((acc, q2, i2) => {
                  if (q2.type === 'mcq') return acc + (userAnswers[i2] !== null ? 1 : 0);
                  else return acc + (userAnswers[i2].some(x=>x!==null) ? 1 : 0);
                }, 0);
                scoreInfo.textContent = `ÄÃ£ tráº£ lá»i: ${answeredCount}/${shuffledQuestions.length}`;
                setSubmitState(answeredCount > 0, 'Ná»™p bÃ i');
              });

              const btnWrap = document.createElement('div');
              btnWrap.className = 'flex items-center';
              btnWrap.appendChild(btnTrue);
              btnWrap.appendChild(btnFalse);
              row.appendChild(btnWrap);

              opts.appendChild(row);
            });

            qWrap.appendChild(opts);
          }

          quizContent.appendChild(qWrap);
        });

        const anyAnswered = userAnswers.some(x => (Array.isArray(x) ? x.some(v=>v!==null) : x !== null));
        setSubmitState(anyAnswered, 'Ná»™p bÃ i');
        btnNext.classList.add('hidden');

      } else {
        const q = shuffledQuestions[0];
        const qWrap = document.createElement('div');
        qWrap.className = '';

        const qTitle = document.createElement('h3');
        qTitle.className = 'text-2xl font-bold text-gray-800 mb-6';
        qTitle.innerHTML = q.q;
        qWrap.appendChild(qTitle);

        if (q.type === 'mcq') {
          const opts = document.createElement('div');
          opts.className = 'space-y-3 mb-6';
          q.o.forEach((opt, idx) => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'w-full text-left p-4 rounded-lg border-2 border-gray-200 transition-all mb-1 flex items-center justify-between';
            btn.innerHTML = `<span class="font-medium text-gray-800">${opt}</span><span class="icon-area"></span>`;

            if (userAnswers[0] === idx) btn.classList.add('border-blue-500','bg-blue-50');
            btn.addEventListener('click', () => {
              if (userAnswers[0] === idx) { userAnswers[0] = null; btn.classList.remove('border-blue-500','bg-blue-50'); }
              else {
                userAnswers[0] = idx;
                opts.querySelectorAll('button').forEach(b => b.classList.remove('border-blue-500','bg-blue-50'));
                btn.classList.add('border-blue-500','bg-blue-50');
              }
              setSubmitState(userAnswers[0] !== null, 'Ná»™p bÃ i');
            });
            opts.appendChild(btn);
          });
          qWrap.appendChild(opts);
          setSubmitState(userAnswers[0] !== null, 'Ná»™p bÃ i');
          btnNext.classList.add('hidden');
        } else {
          const opts = document.createElement('div');
          opts.className = 'space-y-3 mb-6';
          q.statements.forEach((stmt, sidx) => {
            const row = document.createElement('div');
            row.className = 'flex items-center gap-3';

            const stmtDiv = document.createElement('div');
            stmtDiv.className = 'flex-1 p-3 rounded-lg border border-gray-200';
            stmtDiv.innerHTML = `<div class="font-medium text-gray-800">${stmt}</div>`;

            row.appendChild(stmtDiv);

            const btnTrue = document.createElement('button');
            btnTrue.type = 'button';
            btnTrue.className = 'px-3 py-2 rounded-lg border border-gray-200 mr-2';
            btnTrue.textContent = 'ÄÃšNG';
            const btnFalse = document.createElement('button');
            btnFalse.type = 'button';
            btnFalse.className = 'px-3 py-2 rounded-lg border border-gray-200';
            btnFalse.textContent = 'SAI';

            const val = userAnswers[0][sidx];
            if (val === true) { btnTrue.classList.add('bg-blue-50','border-blue-500'); }
            else if (val === false) { btnFalse.classList.add('bg-blue-50','border-blue-500'); }

            btnTrue.addEventListener('click', () => {
              if (userAnswers[0][sidx] === true) { userAnswers[0][sidx] = null; btnTrue.classList.remove('bg-blue-50','border-blue-500'); }
              else { userAnswers[0][sidx] = true; btnTrue.classList.add('bg-blue-50','border-blue-500'); btnFalse.classList.remove('bg-blue-50','border-blue-500'); }
              setSubmitState(userAnswers[0].some(x=>x!==null), 'Ná»™p bÃ i');
            });
            btnFalse.addEventListener('click', () => {
              if (userAnswers[0][sidx] === false) { userAnswers[0][sidx] = null; btnFalse.classList.remove('bg-blue-50','border-blue-500'); }
              else { userAnswers[0][sidx] = false; btnFalse.classList.add('bg-blue-50','border-blue-500'); btnTrue.classList.remove('bg-blue-50','border-blue-500'); }
              setSubmitState(userAnswers[0].some(x=>x!==null), 'Ná»™p bÃ i');
            });

            const btnWrap = document.createElement('div');
            btnWrap.className = 'flex items-center';
            btnWrap.appendChild(btnTrue);
            btnWrap.appendChild(btnFalse);
            row.appendChild(btnWrap);

            opts.appendChild(row);
          });
          qWrap.appendChild(opts);
          setSubmitState(userAnswers[0].some(x=>x!==null), 'Ná»™p bÃ i');
          btnNext.classList.add('hidden');
        }

        quizContent.appendChild(qWrap);
      }
    } // renderQuiz end

    // Submit button helper
    function setSubmitState(enabled, text) {
      if (enabled) {
        btnSubmit.disabled = false;
        btnSubmit.classList.remove('cursor-not-allowed','bg-gray-300','text-gray-500');
        btnSubmit.classList.add('bg-blue-600','text-white');
      } else {
        btnSubmit.disabled = true;
        btnSubmit.classList.add('cursor-not-allowed','bg-gray-300','text-gray-500');
        btnSubmit.classList.remove('bg-blue-600','text-white');
      }
      if (text) btnSubmit.textContent = text;
    }

    // grading helper for TF question: counts correct sub-items and maps to points
    function tfPointsForCorrectCount(n) {
      if (n <= 0) return 0;
      if (n === 1) return 0.1;
      if (n === 2) return 0.25;
      if (n === 3) return 0.5;
      if (n === 4) return 1;
      return 0;
    }

    // Submit handler
    btnSubmit.addEventListener('click', () => {
      if (!quizStarted) return;
      if (btnSubmit.disabled && quizCompleted) return;

      const confirmMsg = 'Báº¡n cÃ³ cháº¯c muá»‘n ná»™p bÃ i? Sau khi ná»™p sáº½ khÃ´ng thá»ƒ thay Ä‘á»•i Ä‘Ã¡p Ã¡n.';
      const warningToggle = document.getElementById('warningToggle');
      const warningsEnabled = warningToggle ? warningToggle.checked : true;
      if (warningsEnabled) {
        if (!confirm(confirmMsg)) return;
      }

      if (quizMode === 'full') {
        const anyAnswered = userAnswers.some(x => (Array.isArray(x) ? x.some(v=>v!==null) : x !== null));
        if (!anyAnswered) return;

        let totalPoints = 0;
        let totalPossible = 0;
        shuffledQuestions.forEach((q, i) => {
          if (q.type === 'mcq') {
            totalPossible += 1;
            if (userAnswers[i] === q.c) totalPoints += 1;
          } else if (q.type === 'tf') {
            totalPossible += 1;
            const correctArr = q.answers;
            const userArr = userAnswers[i];
            let correctCount = 0;
            for (let j=0;j<4;j++){
              if (userArr[j] === null) continue;
              if (userArr[j] === correctArr[j]) correctCount++;
            }
            totalPoints += tfPointsForCorrectCount(correctCount);
          }
        });

        score = totalPoints;
        quizCompleted = true;

        quizContent.innerHTML = '';
        const summary = document.createElement('div');
        summary.className = 'mb-6 p-4 rounded-lg border bg-gray-50';
        const pct = Math.round((totalPoints/totalPossible)*100);
        summary.innerHTML = `<div class="text-center"><div class="text-3xl font-bold text-blue-600">${(Math.round(totalPoints*100)/100)}/${totalPossible}</div><div class="text-lg text-gray-600">Äiá»ƒm sá»‘: ${pct}%</div></div>`;
        quizContent.appendChild(summary);

        shuffledQuestions.forEach((q, qi) => {
          const qWrap = document.createElement('div');
          qWrap.className = 'mb-6 pb-4 border-b';
          const qTitle = document.createElement('h3');
          qTitle.className = 'text-lg font-semibold mb-3';
          qTitle.innerHTML = `CÃ¢u ${qi+1}. ${q.q}`;

          qWrap.appendChild(qTitle);

          if (q.type === 'mcq') {
            const opts = document.createElement('div');
            opts.className = 'space-y-2';
            q.o.forEach((opt, oi) => {
              const div = document.createElement('div');
              div.className = 'w-full text-left p-3 rounded-lg border-2 transition-all mb-1 flex items-center justify-between';
              if (oi === q.c) {
                if (userAnswers[qi] === q.c) {
                  div.classList.add('border-green-500','bg-green-50');
                  div.innerHTML = `<span class="font-medium text-gray-800">${opt}</span><span class="text-green-700 font-semibold">ÄÃšNG</span>`;
                } else {
                  div.classList.add('border-gray-200');
                  div.innerHTML = `<span class="font-medium text-gray-800">${opt}</span><span class="text-gray-600">ÄÃ¡p Ã¡n Ä‘Ãºng</span>`;
                }
              } else if (userAnswers[qi] === oi) {
                div.classList.add('border-red-500','bg-red-50');
                div.innerHTML = `<span class="font-medium text-gray-800">${opt}</span><span class="text-red-700 font-semibold">SAI</span>`;
              } else {
                div.classList.add('border-gray-200');
                div.innerHTML = `<span class="font-medium text-gray-800">${opt}</span><span></span>`;
              }
              opts.appendChild(div);
            });
            qWrap.appendChild(opts);
          } else if (q.type === 'tf') {
            const list = document.createElement('div');
            list.className = 'space-y-2';
            q.statements.forEach((stmt, sidx) => {
              const correct = q.answers[sidx];
              const userVal = userAnswers[qi][sidx];
              const div = document.createElement('div');
              div.className = 'w-full text-left p-3 rounded-lg border-2 flex items-center justify-between';
              if (userVal === null) {
                div.classList.add('border-gray-200','bg-gray-50');
                div.innerHTML = `<div><div class="font-medium text-gray-800">${stmt}</div><div class="text-gray-600 text-sm">Báº¡n chÆ°a chá»n</div></div><div class="text-gray-600">ÄÃ¡p Ã¡n: ${correct ? 'ÄÃšNG' : 'SAI'}</div>`;
              } else if (userVal === correct) {
                div.classList.add('border-green-500','bg-green-50');
                div.innerHTML = `<div class="font-medium text-gray-800">${stmt}</div><div class="text-green-700 font-semibold">Báº¡n chá»n: ${userVal ? 'ÄÃšNG' : 'SAI'}</div>`;
              } else {
                div.classList.add('border-red-500','bg-red-50');
                div.innerHTML = `<div class="font-medium text-gray-800">${stmt}</div><div class="text-red-700 font-semibold">Báº¡n chá»n: ${userVal ? 'ÄÃšNG' : 'SAI'}</div><div class="text-gray-600 text-sm">ÄÃ¡p Ã¡n: ${correct ? 'ÄÃšNG' : 'SAI'}</div>`;
              }
              list.appendChild(div);
            });
            let correctCount = 0;
            for (let j=0;j<4;j++) if (userAnswers[qi][j] !== null && userAnswers[qi][j] === q.answers[j]) correctCount++;
            const pts = tfPointsForCorrectCount(correctCount);
            const ptsDiv = document.createElement('div');
            ptsDiv.className = 'mt-2 text-sm text-gray-700 font-semibold';
            ptsDiv.textContent = `Äiá»ƒm Ä‘áº¡t Ä‘Æ°á»£c cho cÃ¢u nÃ y: ${pts}`;
            qWrap.appendChild(list);
            qWrap.appendChild(ptsDiv);
          }

          quizContent.appendChild(qWrap);
        });

        setSubmitState(false, 'ÄÃ£ ná»™p');
        btnNext.classList.add('hidden');
      } else {
        if (userAnswers[0] === null || (Array.isArray(userAnswers[0]) && !userAnswers[0].some(x=>x!==null))) return;

        const q = shuffledQuestions[0];
        if (q.type === 'mcq') {
          const isCorrect = userAnswers[0] === q.c;
          score = isCorrect ? 1 : 0;
          quizContent.innerHTML = '';
          const qWrap = document.createElement('div');
          const qTitle = document.createElement('h3');
          qTitle.className = 'text-2xl font-bold text-gray-800 mb-6';
          qTitle.innerHTML = q.q;
          qWrap.appendChild(qTitle);
          const opts = document.createElement('div');
          opts.className = 'space-y-3 mb-6';
          q.o.forEach((opt, idx) => {
            const div = document.createElement('div');
            div.className = 'w-full text-left p-4 rounded-lg border-2 transition-all mb-1 flex items-center justify-between';
            if (idx === q.c) {
              div.classList.add('border-green-500','bg-green-50');
              div.innerHTML = `<span class="font-medium text-gray-800">${opt}</span><span class="text-green-700 font-semibold">ÄÃšNG</span>`;
            } else if (userAnswers[0] === idx && idx !== q.c) {
              div.classList.add('border-red-500','bg-red-50');
              div.innerHTML = `<span class="font-medium text-gray-800">${opt}</span><span class="text-red-700 font-semibold">SAI â€” ÄÃ¡p Ã¡n lÃ : ${q.o[q.c]}</span>`;
            } else {
              div.classList.add('border-gray-200');
              div.innerHTML = `<span class="font-medium text-gray-800">${opt}</span><span class="icon-area"></span>`;
            }
            opts.appendChild(div);
          });
          qWrap.appendChild(opts);
          quizContent.appendChild(qWrap);
          quizCompleted = true;
          setSubmitState(false, 'ÄÃ£ ná»™p');
          btnNext.classList.remove('hidden');
        } else {
          const userArr = userAnswers[0];
          let correctCount = 0;
          for (let i=0;i<4;i++) if (userArr[i] !== null && userArr[i] === q.answers[i]) correctCount++;
          const pts = tfPointsForCorrectCount(correctCount);
          score = pts;

          quizContent.innerHTML = '';
          const qWrap = document.createElement('div');
          const qTitle = document.createElement('h3');
          qTitle.className = 'text-2xl font-bold text-gray-800 mb-6';
          qTitle.innerHTML = q.q;
          qWrap.appendChild(qTitle);
          const list = document.createElement('div'); list.className = 'space-y-3 mb-6';
          q.statements.forEach((stmt,sidx) => {
            const div = document.createElement('div');
            div.className = 'w-full text-left p-4 rounded-lg border-2 transition-all mb-1 flex items-center justify-between';
            const correct = q.answers[sidx];
            const userVal = userArr[sidx];
            if (userVal === null) {
              div.classList.add('border-gray-200','bg-gray-50');
              div.innerHTML = `<div class="font-medium text-gray-800">${stmt}</div><div class="text-gray-600">Báº¡n chÆ°a chá»n â€” ÄÃ¡p Ã¡n: ${correct ? 'ÄÃšNG' : 'SAI'}</div>`;
            } else if (userVal === correct) {
              div.classList.add('border-green-500','bg-green-50');
              div.innerHTML = `<div class="font-medium text-gray-800">${stmt}</div><div class="text-green-700 font-semibold">Báº¡n chá»n: ${userVal ? 'ÄÃšNG' : 'SAI'}</div>`;
            } else {
              div.classList.add('border-red-500','bg-red-50');
              div.innerHTML = `<div class="font-medium text-gray-800">${stmt}</div><div class="text-red-700 font-semibold">Báº¡n chá»n: ${userVal ? 'ÄÃšNG' : 'SAI'}</div><div class="text-gray-600">ÄÃ¡p Ã¡n: ${correct ? 'ÄÃšNG' : 'SAI'}</div>`;
            }
            list.appendChild(div);
          });
          qWrap.appendChild(list);
          const ptsDiv = document.createElement('div'); ptsDiv.className = 'text-sm font-semibold'; ptsDiv.textContent = `Äiá»ƒm Ä‘áº¡t Ä‘Æ°á»£c: ${pts}`;
          qWrap.appendChild(ptsDiv);
          quizContent.appendChild(qWrap);
          quizCompleted = true;
          setSubmitState(false, 'ÄÃ£ ná»™p');
          btnNext.classList.remove('hidden');
        }
      }
    });

    // Next button (random mode)
    btnNext.addEventListener('click', () => {
      if (quizMode === 'random') initializeQuiz('random');
    });

    // Restart / navigation handlers
btnRestart.addEventListener('click', () => {
  if (!currentSubject) return;

  // Náº¿u Ä‘ang á»Ÿ cháº¿ Ä‘á»™ random: ngay láº­p tá»©c láº¥y cÃ¢u random khÃ¡c,
  // KHÃ”NG há»i confirm dÃ¹ toggle cáº£nh bÃ¡o Ä‘ang báº­t hay táº¯t.
  if (quizMode === 'random') {
    initializeQuiz('random');
    return;
  }

  // Cháº¿ Ä‘á»™ full (cÅ©): giá»¯ hÃ nh vi confirm nhÆ° trÆ°á»›c
  if (quizStarted && !quizCompleted) {
    if (!confirm('Báº¡n cÃ³ muá»‘n lÃ m láº¡i? Má»i cÃ¢u tráº£ lá»i hiá»‡n táº¡i sáº½ bá»‹ máº¥t.')) return;
  }
  initializeQuiz(quizMode);
});


    resultRestart.addEventListener('click', () => {
      if (!currentSubject) return;
      initializeQuiz(quizMode);
    });

    function navigateHomeWithConfirm() {
      if (quizStarted && !quizCompleted) {
        if (!confirm('Báº¡n cÃ³ cháº¯c muá»‘n rá»i trang? Má»i cÃ¢u tráº£ lá»i sáº½ khÃ´ng Ä‘Æ°á»£c lÆ°u.')) return false;
      }
      currentSubject = null;
      quizStarted = false;
      renderQuiz();
      return true;
    }

    resultHome.addEventListener('click', () => {
      navigateHomeWithConfirm();
    });

    backHomeBtn.addEventListener('click', () => {
      if (quizStarted && !quizCompleted && document.getElementById('warningToggle') && document.getElementById('warningToggle').checked) {
        const ok = confirm('Báº¡n Ä‘ang lÃ m bÃ i, má»i tiáº¿n trÃ¬nh sáº½ máº¥t. Báº¡n cÃ³ cháº¯c khÃ´ng?');
        if (!ok) return;
      }
      quizStarted = false;
      quizCompleted = false;
      currentSubject = null;
      renderQuiz();
    });

    backToSubject.addEventListener('click', () => navigateHomeWithConfirm());

    // selection listeners
    selectOnSinh29126.addEventListener('click', () => {
      currentSubject = 'onsinh29126';
      subjectTitle.textContent = subjectData.onsinh29126.fullName || 'Ã”n Sinh 29.1.26';
      fullModeDesc.textContent = `LÃ m háº¿t ${subjectData.onsinh29126.questions ? subjectData.onsinh29126.questions.length : '...'} cÃ¢u há»i`;
      subjectScreen.classList.add('hidden');
      modeScreen.classList.remove('hidden');
    });

    startFullBtn.addEventListener('click', () => initializeQuiz('full'));
    startRandomBtn.addEventListener('click', () => initializeQuiz('random'));

    // beforeunload warning
    window.addEventListener('beforeunload', (e) => {
      const warningToggle = document.getElementById('warningToggle');
      const warningsEnabled = warningToggle ? warningToggle.checked : true;
      if (!warningsEnabled) return;
      if (!quizStarted || quizCompleted) return;
      e.preventDefault();
      e.returnValue = '';
    });

    // persist warning toggle
    (function initWarningToggle(){
      const wt = document.getElementById('warningToggle');
      let saved = localStorage.getItem('warningsEnabled');
      saved = saved === null ? 'true' : saved;
      wt.checked = saved === 'true';
      wt.addEventListener('change', () => {
        localStorage.setItem('warningsEnabled', wt.checked ? 'true' : 'false');
      });
    })();

    // initial render
    renderQuiz();

  </script>
<!-- Firebase SDK - Di chuyá»ƒn xuá»‘ng Ä‘Ã¢y -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<script>
// Cáº¥u hÃ¬nh Firebase
const firebaseConfig = {
  apiKey: "AIzaSyB0cL2gvBQHfz6oxrOVWDOR0h2xb822HDM",
  authDomain: "bruh-68680.firebaseapp.com",
  databaseURL: "https://bruh-68680-default-rtdb.firebaseio.com",
  projectId: "bruh-68680",
  storageBucket: "bruh-68680.firebasestorage.app",
  messagingSenderId: "322108184836",
  appId: "1:322108184836:web:f3a60b8fbd50ac1387d851"
};

// Khá»Ÿi táº¡o Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
const presenceRef = database.ref('presence');

// Táº¡o ID duy nháº¥t cho TRÃŒNH DUYá»†T
let browserId = localStorage.getItem('browserId');
if (!browserId) {
  browserId = 'browser_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  localStorage.setItem('browserId', browserId);
}

const tabId = 'tab_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
const tabsKey = 'activeTabs_' + browserId;
let activeTabs = JSON.parse(localStorage.getItem(tabsKey) || '[]');
activeTabs.push(tabId);
localStorage.setItem(tabsKey, JSON.stringify(activeTabs));

const myPresenceRef = presenceRef.child(browserId);

// Chá»‰ set online náº¿u Ä‘Ã¢y lÃ  tab Ä‘áº§u tiÃªn
if (activeTabs.length === 1) {
  myPresenceRef.set({
    online: true,
    timestamp: Date.now()
  });
}

// ÄÃ¡nh dáº¥u offline khi rá»i trang
myPresenceRef.onDisconnect().remove();

// Láº¯ng nghe sá»‘ ngÆ°á»i online
presenceRef.on('value', (snapshot) => {
  const onlineUsers = snapshot.numChildren();
  const onlineCountEl = document.getElementById('onlineCount');
  if (onlineCountEl) {
    onlineCountEl.textContent = onlineUsers;
  }
});

// Cleanup khi táº¯t tab
window.addEventListener('beforeunload', () => {
  // XÃ³a tab nÃ y khá»i danh sÃ¡ch
  let tabs = JSON.parse(localStorage.getItem(tabsKey) || '[]');
  tabs = tabs.filter(id => id !== tabId);
  localStorage.setItem(tabsKey, JSON.stringify(tabs));
  
  // Chá»‰ remove presence náº¿u khÃ´ng cÃ²n tab nÃ o
  if (tabs.length === 0) {
    myPresenceRef.remove();
    localStorage.removeItem('browserId');
    localStorage.removeItem(tabsKey);
  }
});

// Heartbeat Ä‘á»ƒ cleanup cÃ¡c tab zombie
setInterval(() => {
  let tabs = JSON.parse(localStorage.getItem(tabsKey) || '[]');
  // Giá»¯ tab hiá»‡n táº¡i trong danh sÃ¡ch
  if (!tabs.includes(tabId)) {
    tabs.push(tabId);
    localStorage.setItem(tabsKey, JSON.stringify(tabs));
  }
  
  // Cáº­p nháº­t timestamp Ä‘á»ƒ giá»¯ káº¿t ná»‘i
  if (tabs.length > 0) {
    myPresenceRef.set({
      online: true,
      timestamp: Date.now()
    });
  }
}, 1000);

// Xá»­ lÃ½ khi tab bá»‹ áº©n
document.addEventListener('visibilitychange', () => {
  if (!document.hidden) {
    // Khi quay láº¡i tab, Ä‘áº£m báº£o presence váº«n cÃ²n
    let tabs = JSON.parse(localStorage.getItem(tabsKey) || '[]');
    if (tabs.length > 0) {
      myPresenceRef.set({
        online: true,
        timestamp: Date.now()
      });
    }
  }
});

// Function Ä‘á»ƒ clean up presence data cÅ© (chá»‰ xÃ³a data quÃ¡ 1 phÃºt)
window.cleanupOldPresence = function() {
  presenceRef.once('value', (snapshot) => {
    const now = Date.now();
    const oneMinuteAgo = now - 10000;
    
    snapshot.forEach((childSnapshot) => {
      const data = childSnapshot.val();
      if (data && data.timestamp < oneMinuteAgo) {
        childSnapshot.ref.remove();
        console.log('ÄÃ£ xÃ³a presence cÅ©:', childSnapshot.key);
      }
    });
    
    console.log('âœ… ÄÃ£ dá»n dáº¹p presence data cÅ©');
  });
}

// Function reset toÃ n bá»™ (CHá»ˆ dÃ¹ng khi cáº§n thiáº¿t)
window.resetOnlineCount = function() {
  if (!confirm('âš ï¸ Thao tÃ¡c nÃ y sáº½ reset Táº¤T Cáº¢ ngÆ°á»i online vá» 0. Báº¡n cÃ³ cháº¯c cháº¯n?')) {
    return;
  }
  
  firebase.database().ref('presence').remove().then(() => {
    console.log('BÆ°á»›c 1: ÄÃ£ xÃ³a toÃ n bá»™ presence data.');
    
    setTimeout(() => {
      const browserId = localStorage.getItem('browserId');
      if (browserId) {
        const myPresenceRef = firebase.database().ref('presence').child(browserId);
        myPresenceRef.set({
          online: true,
          timestamp: Date.now()
        }).then(() => {
          console.log('BÆ°á»›c 2: ÄÃ£ Ä‘Äƒng kÃ½ láº¡i. Sá»‘ ngÆ°á»i online sáº½ hiá»ƒn thá»‹ 1 sau vÃ i giÃ¢y.');
        });
      }
    }, 1000);
  }).catch(error => {
    console.error('Lá»—i:', error);
  });
}

// Tá»± Ä‘á»™ng cleanup presence data cÅ© khi táº£i trang (thay vÃ¬ reset toÃ n bá»™)
setTimeout(() => {
  cleanupOldPresence();
}, 2000);

console.log('ğŸ’¡ Lá»‡nh há»¯u Ã­ch:');
console.log('   - cleanupOldPresence() : XÃ³a presence data cÅ© hÆ¡n 1 phÃºt');
console.log('   - resetOnlineCount() : Reset toÃ n bá»™ (cáº©n tháº­n!)');
</script>
<!-- Container Ä‘á»ƒ nhÃºng ná»™i dung quizls.html -->
<div id="embeddedHistoryWrap" class="fixed inset-0 z-50 bg-white/90 hidden overflow-auto p-6">
  <div class="max-w-5xl mx-auto bg-white rounded-2xl shadow-xl p-6 relative">
    <button id="closeHistoryBtn" class="absolute top-4 right-4 bg-gray-100 px-3 py-2 rounded-lg shadow hover:bg-gray-200">ÄÃ³ng âœ•</button>
    <div id="embeddedHistory" class="prose"></div>
  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const openHistoryBtn = document.getElementById('openHistoryBtn');
  if (openHistoryBtn) {
    openHistoryBtn.addEventListener('click', () => {
      window.location.href = 'quizls.html';
    });
  }
});
</script>

</body>
</html>
