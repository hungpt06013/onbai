<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>√în T·∫≠p B√†i H·ªçc - ƒêa M√¥n</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="antialiased bg-gradient-to-br from-blue-50 to-green-50 min-h-screen p-6">
<iframe data-testid="embed-iframe" style="border-radius:12px" src="https://open.spotify.com/embed/playlist/37i9dQZF1DX2vYju3i0lNX?utm_source=generator" width="100%" height="152" frameBorder="0" allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture" loading="lazy"></iframe>
<div style="position:fixed;top:10px;right:10px;z-index:9999;background:rgba(0,0,0,0.8);color:white;padding:10px 20px;border-radius:20px;display:flex;align-items:center;gap:8px;box-shadow:0 4px 12px rgba(0,0,0,0.3);">
  <svg width="12" height="12" style="animation:blink 1.5s infinite;">
    <circle cx="6" cy="6" r="6" fill="#22c55e"/>
  </svg>
  <span style="font-size:14px;font-weight:600;">
    <span id="onlineCount">0</span> ng∆∞·ªùi ƒëang online
  </span>
</div>

<style>
@keyframes blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.3; }
}
</style>

  <!-- SUBJECT SELECTION SCREEN -->
  <div id="subjectScreen" class="min-h-screen flex items-center justify-center">
    <div class="max-w-4xl mx-auto">
      <div class="bg-white rounded-3xl shadow-2xl overflow-hidden">
	  <div class="relative z-50 p-3 rounded-lg border bg-white shadow-lg flex items-center gap-2">
  <input type="checkbox" id="warningToggle" class="w-4 h-4" checked>
  <label for="warningToggle" class="text-sm text-gray-700 cursor-pointer font-bold">
    C·∫£nh b√°o khi n·ªôp b√†i / tho√°t trang / reload
  </label>
</div>
        <div class="bg-gradient-to-r from-blue-600 via-green-600 to-teal-600 p-8 text-white text-center">
          <div class="mb-4">
            <div class="inline-block bg-white/20 rounded-full p-4 backdrop-blur-sm">
              <svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
              </svg>
            </div>
          </div>
          <h1 class="text-4xl font-bold mb-3">√în T·∫≠p B√†i H·ªçc</h1>
          <p class="text-xl text-blue-100">Ch·ªçn m√¥n h·ªçc ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
        </div>

        <div class="p-8">
          <div class="grid md:grid-cols-3 gap-6">
            <button id="selectOnSinh29126" class="group relative overflow-hidden bg-gradient-to-br from-emerald-600 to-emerald-700 text-white p-8 rounded-xl hover:from-emerald-700 hover:to-emerald-800 transition-all transform hover:scale-[1.02] shadow-lg">
              <div class="relative z-10">
                <div class="flex items-center justify-center mb-4">
                  <!-- DNA icon -->
                  <svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                      d="M9 3v1m6-1v1M9 19v1m6-1v1M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6m-6 6h6"/>
                    <circle cx="9" cy="9" r="1" fill="currentColor"/>
                    <circle cx="15" cy="9" r="1" fill="currentColor"/>
                    <circle cx="9" cy="15" r="1" fill="currentColor"/>
                    <circle cx="15" cy="15" r="1" fill="currentColor"/>
                  </svg>
                </div>
                <h3 class="text-2xl font-bold mb-2">√în Sinh 29.1.26</h3>
                <p class="text-emerald-100 text-sm">√în Sinh 29.1.26</p>
                <div class="mt-4 text-xs bg-white/20 rounded-full px-3 py-1 w-fit mx-auto">17 c√¢u h·ªèi</div>
              </div>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- MODE SELECTION SCREEN -->
  <div id="modeScreen" class="hidden min-h-screen flex items-center justify-center">
    <div class="max-w-4xl mx-auto">
      <div class="bg-white rounded-3xl shadow-2xl overflow-hidden">
        <div class="bg-gradient-to-r from-blue-600 via-green-600 to-teal-600 p-8 text-white text-center relative">

          <button id="backToSubject" class="absolute top-4 left-4 z-20 flex items-center gap-2 text-white hover:text-blue-100 transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            <span class="font-medium">Ch·ªçn m√¥n kh√°c</span>
          </button>
	  
          <div class="mb-4">
            <div class="inline-block bg-white/20 rounded-full p-4 backdrop-blur-sm">
              <svg class="w-16 h-16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
            </div>
          </div>

          <h1 class="text-4xl font-bold mb-3" id="subjectTitle"></h1>
          <p class="text-xl text-blue-100">Ch·ªçn ch·∫ø ƒë·ªô l√†m b√†i</p>
        </div>

        <div class="p-8">
          <div class="grid md:grid-cols-2 gap-4">
            <button id="startFull" class="group relative overflow-hidden bg-gradient-to-br from-blue-600 to-blue-700 text-white p-6 rounded-xl hover:from-blue-700 hover:to-blue-800 transition-all transform hover:scale-[1.02] shadow-lg">
              <div class="relative z-10">
                <div class="flex items-center justify-center mb-3">
                  <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2" />
                  </svg>
                </div>
                <h3 class="text-xl font-bold mb-2">B√†i Test ƒê·∫ßy ƒê·ªß</h3>
                <p class="text-blue-100 text-sm mb-3" id="fullModeDesc"></p>
                <div class="flex items-center justify-center gap-2 text-xs bg-white/20 rounded-full px-3 py-1 w-fit mx-auto">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <span>Kh√¥ng gi·ªõi h·∫°n th·ªùi gian</span>
                </div>
              </div>
            </button>

            <button id="startRandom" class="group relative overflow-hidden bg-gradient-to-br from-green-600 to-green-700 text-white p-6 rounded-xl hover:from-green-700 hover:to-green-800 transition-all transform hover:scale-[1.02] shadow-lg">
              <div class="relative z-10">
                <div class="flex items-center justify-center mb-3">
                  <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581" />
                  </svg>
                </div>
                <h3 class="text-xl font-bold mb-2">Luy·ªán T·∫≠p Ng·∫´u Nhi√™n</h3>
                <p class="text-green-100 text-sm mb-3">M·ªói l·∫ßn 1 c√¢u random</p>
                <div class="flex items-center justify-center gap-2 text-xs bg-white/20 rounded-full px-3 py-1 w-fit mx-auto">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                  </svg>
                  <span>Kh√¥ng gi·ªõi h·∫°n</span>
                </div>
              </div>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- QUIZ SCREEN -->
  <div id="quizScreen" class="hidden min-h-screen flex items-start justify-center pt-12">
    <div class="max-w-3xl mx-auto w-full">
      <div class="bg-white rounded-2xl shadow-xl p-8">
        <div class="flex justify-between items-center mb-6">
          <button id="backHome" class="flex items-center gap-2 text-gray-600 hover:text-gray-800 transition-colors">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            <span class="font-medium">Trang ch·ªß</span>
          </button>

          <div class="flex items-center gap-3">
            <button id="btnRestart" class="flex items-center gap-2 px-4 py-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors border border-blue-200" title="L√†m l·∫°i b√†i test">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12a9 9 0 0114.32-6.32L21 6m0 0v-4m0 4h-4"/>
              </svg>
              <span class="font-medium hidden sm:inline">L√†m l·∫°i</span>
            </button>
            <div class="flex items-center gap-4 border-l pl-3">
              <div id="countInfo" class="text-sm font-semibold text-gray-500"></div>
              <div id="scoreInfo" class="text-lg font-bold text-blue-600"></div>
            </div>
          </div>
        </div>

        <div id="progressWrap" class="mb-6">
          <div id="progressBar" class="w-full bg-gray-200 rounded-full h-2">
            <div id="progressFill" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width:0%"></div>
          </div>
        </div>

        <div id="quizContent"></div>

        <div class="flex gap-3 mt-6">
          <button id="btnSubmit" class="flex-1 py-3 rounded-lg font-semibold transition-colors bg-gray-300 text-gray-500 cursor-not-allowed" disabled>Ki·ªÉm tra ƒë√°p √°n / N·ªôp b√†i</button>
          <button id="btnNext" class="hidden flex-1 bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition-colors">C√¢u ti·∫øp theo ‚Üí</button>
        </div>
      </div>
    </div>
  </div>

  <!-- RESULT SCREEN -->
  <div id="resultScreen" class="hidden min-h-screen p-6">
    <div class="max-w-2xl mx-auto">
      <div class="bg-white rounded-2xl shadow-xl p-8 text-center">
        <div id="trophyWrap" class="w-20 h-20 mx-auto text-yellow-500 mb-4">
          <svg viewBox="0 0 24 24" class="w-20 h-20 inline-block" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 21h8M12 3v4m5 0a5 5 0 01-10 0"/>
          </svg>
        </div>
        <h2 class="text-3xl font-bold text-gray-800 mb-4">Ho√†n th√†nh b√†i ki·ªÉm tra! üéâ</h2>
        <div id="resultScoreLarge" class="text-6xl font-bold text-blue-600 mb-2">0/0</div>
        <p id="resultPercent" class="text-xl text-gray-600 mb-6">ƒêi·ªÉm s·ªë: 0%</p>

        <p id="resultRemark" class="text-lg font-semibold mb-6"></p>

        <div class="flex flex-col gap-3 mt-8">
          <button id="resultRestart" class="flex items-center justify-center gap-2 w-full bg-blue-600 text-white px-8 py-4 rounded-lg hover:bg-blue-700 transition-colors font-semibold text-lg">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h4V6m0 0a9 9 0 1118 0M21 14v6h-6"/>
            </svg>
            L√†m l·∫°i b√†i ki·ªÉm tra
          </button>

          <button id="resultHome" class="flex items-center justify-center gap-2 w-full bg-gray-600 text-white px-8 py-4 rounded-lg hover:bg-gray-700 transition-colors font-semibold text-lg">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3"/>
            </svg>
            V·ªÅ trang ch·ªß
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // === DATA ===
const subjectData = {
  onsinh29126: {
    fullName: '√în Sinh 29.1.26',
    questions: [
      {
        type: 'mcq',
        q: 'Sinh tr∆∞·ªüng l√†',
        o: [
          's·ª± tƒÉng l√™n v·ªÅ k√≠ch th∆∞·ªõc c∆° th·ªÉ do tƒÉng l√™n v·ªÅ k√≠ch th∆∞·ªõc t·∫ø b√†o.',
          's·ª± tƒÉng l√™n v·ªÅ kh·ªëi l∆∞·ª£ng c∆° th·ªÉ do tƒÉng l√™n v·ªÅ s·ªë l∆∞·ª£ng t·∫ø b√†o.',
          's·ª± tƒÉng l√™n v·ªÅ k√≠ch th∆∞·ªõc v√† kh·ªëi l∆∞·ª£ng c∆° th·ªÉ do tƒÉng l√™n v·ªÅ k√≠ch th∆∞·ªõc t·∫ø b√†o.',
          's·ª± tƒÉng l√™n v·ªÅ k√≠ch th∆∞·ªõc v√† kh·ªëi l∆∞·ª£ng c∆° th·ªÉ do tƒÉng l√™n v·ªÅ s·ªë l∆∞·ª£ng v√† k√≠ch th∆∞·ªõc t·∫ø b√†o.'
        ],
        c: 3
      },
      {
        type: 'mcq',
        q: 'Ph√°t tri·ªÉn l√†',
        o: [
          'nh·ªØng bi·∫øn ƒë·ªïi c·ªßa c∆° th·ªÉ sinh v·∫≠t bao g·ªìm ba qu√° tr√¨nh li√™n quan m·∫≠t thi·∫øt v·ªõi nhau l√† sinh tr∆∞·ªüng, ph√¢n h√≥a t·∫ø b√†o v√† ph√°t sinh h√¨nh th√°i c√°c c∆° quan c·ªßa c∆° th·ªÉ.',
          's·ª± tƒÉng l√™n v·ªÅ k√≠ch th∆∞·ªõc v√† kh·ªëi l∆∞·ª£ng c∆° th·ªÉ do tƒÉng l√™n v·ªÅ s·ªë l∆∞·ª£ng v√† k√≠ch th∆∞·ªõc t·∫ø b√†o.',
          'nh·ªØng bi·∫øn ƒë·ªïi c·ªßa c∆° th·ªÉ sinh v·∫≠t d∆∞·ªõi t√°c ƒë·ªông tr·ª±c ti·∫øp c·ªßa m√¥i tr∆∞·ªùng s·ªëng m√† kh√¥ng li√™n quan ƒë·∫øn bi·∫øn ƒë·ªïi v·∫≠t ch·∫•t di truy·ªÅn.',
          'nh·ªØng bi·∫øn ƒë·ªïi ƒë·ªôt ng·ªôt c·ªßa c∆° th·ªÉ sinh v·∫≠t do bi·∫øn ƒë·ªïi v·∫≠t ch·∫•t di truy·ªÅn m√† kh√¥ng li√™n quan ƒë·∫øn bi·∫øn ƒë·ªïi ƒëi·ªÅu ki·ªán m√¥i tr∆∞·ªùng s·ªëng.'
        ],
        c: 0
      },
      {
        type: 'mcq',
        q: 'Cho b·∫£ng th√¥ng tin sau:<table class="border-collapse border border-gray-400"><thead><tr><th class="border border-gray-300 p-2">Qu√° tr√¨nh</th><th class="border border-gray-300 p-2">Bi·ªÉu hi·ªán</th></tr></thead><tbody><tr><td class="border border-gray-300 p-2">(1) Sinh tr∆∞·ªüng<br>(2) Ph√°t tri·ªÉn</td><td class="border border-gray-300 p-2">(a) Th·ªÉ tr·ªçng l·ª£n con t·ª´ 5kg tƒÉng 8kg.<br>(b) K√≠ch th∆∞·ªõc l√° tƒÉng l√™n.<br>(c) H·∫°t gi·ªëng n·∫£y m·∫ßm.<br>(d) C√¢y b∆∞·ªüi ra l√° non.<br>(e) Tr·ª©ng g√† n·ªü th√†nh g√† con.</td></tr></tbody></table>C√°ch gh√©p n·ªëi ph√π h·ª£p l√†',
        o: [
          '1-a,b; 2-c,d,e.',
          '1-a,c; 2-b,d,e.',
          '1-a,d; 2-b,c,e.',
          '1-a,e; 2-b,c,d.'
        ],
        c: 0
      },
      {
        type: 'mcq',
        q: 'Ph√°t bi·ªÉu n√†o sau ƒë√¢y l√† ƒë√∫ng khi n√≥i v·ªÅ m·ªëi quan h·ªá gi·ªØa sinh tr∆∞·ªüng v√† ph√°t tri·ªÉn?',
        o: [
          'Sinh tr∆∞·ªüng v√† ph√°t tri·ªÉn l√† hai qu√° tr√¨nh c√≥ m·ªëi quan h·ªá ƒë·ªôc l·∫≠p v·ªõi nhau; sinh tr∆∞·ªüng lu√¥n di·ªÖn ra tr∆∞·ªõc ph√°t tri·ªÉn.',
          'Sinh tr∆∞·ªüng v√† ph√°t tri·ªÉn l√† hai qu√° tr√¨nh c√≥ m·ªëi quan h·ªá ƒë·ªôc l·∫≠p v·ªõi nhau; ph√°t tri·ªÉn lu√¥n di·ªÖn ra tr∆∞·ªõc sinh tr∆∞·ªüng.',
          'Sinh tr∆∞·ªüng v√† ph√°t tri·ªÉn l√† hai qu√° tr√¨nh c√≥ m·ªëi quan h·ªá m·∫≠t thi·∫øt v·ªõi nhau; sinh tr∆∞·ªüng t·∫°o ti·ªÅn ƒë·ªÅ cho ph√°t tri·ªÉn c√≤n ph√°t tri·ªÉn s·∫Ω th√∫c ƒë·∫©y sinh tr∆∞·ªüng.',
          'Sinh tr∆∞·ªüng v√† ph√°t tri·ªÉn l√† hai qu√° tr√¨nh c√≥ m·ªëi quan h·ªá m·∫≠t thi·∫øt v·ªõi nhau; ph√°t tri·ªÉn t·∫°o ti·ªÅn ƒë·ªÅ cho sinh tr∆∞·ªüng c√≤n sinh tr∆∞·ªüng s·∫Ω th√∫c ƒë·∫©y ph√°t tri·ªÉn.'
        ],
        c: 2
      },
      {
        type: 'mcq',
        q: 'C∆° s·ªü cho s·ª± sinh tr∆∞·ªüng c·ªßa th·ª±c v·∫≠t l√† s·ª± ph√¢n chia c·ªßa c√°c t·∫ø b√†o thu·ªôc',
        o: [
          'm√¥ m·ªÅm.',
          'm√¥ x·ªëp.',
          'm√¥ d·∫´n.',
          'm√¥ ph√¢n sinh.'
        ],
        c: 3
      },
      {
        type: 'mcq',
        q: 'M√¥ ph√¢n sinh l√†',
        o: [
          'nh√≥m c√°c t·∫ø b√†o c√≥ kh·∫£ nƒÉng ph√¢n chia, gi√∫p cho th·ª±c v·∫≠t tƒÉng tr∆∞·ªüng v·ªÅ k√≠ch th∆∞·ªõc.',
          'nh√≥m c√°c t·∫ø b√†o c√≥ kh·∫£ nƒÉng c·∫£m ·ª©ng, gi√∫p cho th·ª±c v·∫≠t tƒÉng tr∆∞·ªüng v·ªÅ k√≠ch th∆∞·ªõc.',
          'nh√≥m c√°c t·∫ø b√†o c√≥ kh·∫£ nƒÉng bi·ªát h√≥a, gi√∫p cho th·ª±c v·∫≠t tƒÉng tr∆∞·ªüng v·ªÅ k√≠ch th∆∞·ªõc.',
          'nh√≥m c√°c t·∫ø b√†o c√≥ kh·∫£ nƒÉng ph·∫£n bi·ªát h√≥a, gi√∫p cho th·ª±c v·∫≠t tƒÉng tr∆∞·ªüng v·ªÅ k√≠ch th∆∞·ªõc.'
        ],
        c: 0
      },
      {
        type: 'mcq',
        q: 'C√¢y M·ªôt l√° m·∫ßm kh√¥ng c√≥ kh·∫£ nƒÉng tƒÉng k√≠ch th∆∞·ªõc ƒë∆∞·ªùng k√≠nh th√¢n li√™n t·ª•c nh∆∞ c√¢y Hai l√° m·∫ßm l√† do c√¢y M·ªôt l√° m·∫ßm kh√¥ng c√≥',
        o: [
          'm√¥ ph√¢n sinh.',
          'm√¥ ph√¢n sinh ƒë·ªânh.',
          'm√¥ ph√¢n sinh l√≥ng.',
          'm√¥ ph√¢n sinh b√™n.'
        ],
        c: 3
      },
      {
        type: 'mcq',
        q: 'M·ªói sinh v·∫≠t trong qu√° tr√¨nh s·ªëng ƒë·ªÅu tr·∫£i qua c√°c giai ƒëo·∫°n sinh tr∆∞·ªüng v√† ph√°t tri·ªÉn kh√°c nhau g·ªçi l√†',
        o: [
          'v√≤ng ƒë·ªùi.',
          'qu√° tr√¨nh sinh tr∆∞·ªüng.',
          'qu√° tr√¨nh ph√°t tri·ªÉn.',
          'qu√° tr√¨nh bi·∫øn ƒë·ªïi.'
        ],
        c: 0
      },
      {
        type: 'mcq',
        q: 'V√≤ng ƒë·ªùi c·ªßa ·∫øch tr·∫£i qua c√°c giai ƒëo·∫°n l·∫ßn l∆∞·ª£t l√†',
        o: [
          'ph√¥i ‚Üí tr·ª©ng ‚Üí n√≤ng n·ªçc ‚Üí n√≤ng n·ªçc 2 ch√¢n ‚Üí n√≤ng n·ªçc 4 ch√¢n ‚Üí ·∫øch con ‚Üí ·∫øch tr∆∞·ªüng th√†nh.',
          'tr·ª©ng ‚Üí ph√¥i ‚Üí n√≤ng n·ªçc ‚Üí n√≤ng n·ªçc 2 ch√¢n ‚Üí n√≤ng n·ªçc 4 ch√¢n ‚Üí ·∫øch con ‚Üí ·∫øch tr∆∞·ªüng th√†nh.',
          'ph√¥i ‚Üí tr·ª©ng ‚Üí n√≤ng n·ªçc ‚Üí n√≤ng n·ªçc 4 ch√¢n ‚Üí n√≤ng n·ªçc 2 ch√¢n ‚Üí ·∫øch con ‚Üí ·∫øch tr∆∞·ªüng th√†nh.',
          'tr·ª©ng ‚Üí ph√¥i ‚Üí n√≤ng n·ªçc ‚Üí n√≤ng n·ªçc 4 ch√¢n ‚Üí n√≤ng n·ªçc 2 ch√¢n ‚Üí ·∫øch con ‚Üí ·∫øch tr∆∞·ªüng th√†nh.'
        ],
        c: 1
      },
      {
        type: 'mcq',
        q: 'Quan s√°t v√≤ng ƒë·ªùi c·ªßa ·∫øch v√† c·ªßa g√† d∆∞·ªõi ƒë√¢y: https://postimg.cc/G8cQTHjt<br>ƒêi·ªÉm kh√°c nhau c∆° b·∫£n trong v√≤ng ƒë·ªùi c·ªßa g√† so v·ªõi ·∫øch l√†',
        o: [
          'x·∫£y ra nhi·ªÅu s·ª± bi·∫øn ƒë·ªïi ƒë·ªôt ng·ªôt v·ªÅ h√¨nh th√°i.',
          'kh√¥ng x·∫£y ra nhi·ªÅu bi·∫øn ƒë·ªïi ƒë·ªôt ng·ªôt v·ªÅ h√¨nh th√°i.',
          'c√≥ giai ƒëo·∫°n h·ª£p t·ª≠ ph√°t tri·ªÉn th√†nh ph√¥i di·ªÖn ra trong tr·ª©ng ƒë√£ th·ª• tinh.',
          'kh√¥ng c√≥ giai ƒëo·∫°n h·ª£p t·ª≠ ph√°t tri·ªÉn th√†nh ph√¥i di·ªÖn ra trong tr·ª©ng ƒë√£ th·ª• tinh.'
        ],
        c: 1
      },
      {
        type: 'mcq',
        q: 'V√≤ng ƒë·ªùi c·ªßa b∆∞·ªõm tr·∫£i qua c√°c giai ƒëo·∫°n l·∫ßn l∆∞·ª£t l√†',
        o: [
          'tr·ª©ng ‚Üí s√¢u b∆∞·ªõm ‚Üí k√©n ‚Üí b∆∞·ªõm tr∆∞·ªüng th√†nh',
          'tr·ª©ng ‚Üí k√©n ‚Üí s√¢u b∆∞·ªõm ‚Üí b∆∞·ªõm tr∆∞·ªüng th√†nh',
          'k√©n ‚Üí tr·ª©ng ‚Üí s√¢u b∆∞·ªõm ‚Üí b∆∞·ªõm tr∆∞·ªüng th√†nh',
          'k√©n ‚Üí s√¢u b∆∞·ªõm ‚Üí tr·ª©ng ‚Üí b∆∞·ªõm tr∆∞·ªüng th√†nh'
        ],
        c: 0
      },
      {
        type: 'mcq',
        q: 'Sinh tr∆∞·ªüng hay ph√°t tri·ªÉn quan tr·ªçng h∆°n',
        o: [
          'Sinh tr∆∞·ªüng',
          'Ph√°t tri·ªÉn',
          'C·∫£ 2 ƒë·ªÅu quan tr·ªçng nh∆∞ nhau',
          'C·∫£ 2 ƒë·ªÅu kh√¥ng quan tr·ªçng'
        ],
        c: 2
      },
      {
        type: 'mcq',
        q: 'Cho b·∫£ng th√¥ng tin sau:<table class="border-collapse border border-gray-400"><thead><tr><th class="border border-gray-300 p-2">Qu√° tr√¨nh</th><th class="border border-gray-300 p-2">Bi·ªÉu hi·ªán</th></tr></thead><tbody><tr><td class="border border-gray-300 p-2">(1) Sinh tr∆∞·ªüng<br>(2) Ph√°t tri·ªÉn</td><td class="border border-gray-300 p-2">(a) Sau m·ªôt nƒÉm, em h·ªçc sinh l·ªõp 1 cao th√™m 10 cm.<br>(b) H·∫°t ƒë·∫≠u ng√¢m n∆∞·ªõc l√¢u n·ªü to h∆°n l√∫c ƒë·∫ßu.<br>(c) H·∫°t ƒë·ªó n·∫£y m·∫ßm.<br>(d) C√¢y b∆∞·ªüi ra hoa.<br>(e) Tr·ª©ng g√† n·ªü th√†nh g√† con.</td></tr></tbody></table>C√°ch gh√©p n·ªëi ph√π h·ª£p l√†',
        o: [
          '1-a,b; 2-c,d,e.',
          '1-a,c; 2-b,d,e.',
          '1-a,d; 2-b,c,e.',
          '1-a,e; 2-b,c,d.'
        ],
        c: 0
      },
      {
        type: 'mcq',
        q: '·ªû c√¢y Hai l√° m·∫ßm, m√¥ ph√¢n sinh ƒë·ªânh n·∫±m ·ªü v·ªã tr√≠ ƒë·ªânh c·ªßa..., c√≥ ch·ª©c nƒÉng...?',
        o: [
          'r·ªÖ v√† th√¢n - gi√∫p c√¢y sinh tr∆∞·ªüng v·ªÅ chi·ªÅu cao',
          'l√° v√† hoa - gi√∫p c√¢y sinh tr∆∞·ªüng v·ªÅ chi·ªÅu ngang',
          'th√¢n v√† c√†nh - gi√∫p c√¢y ph√°t tri·ªÉn th√™m l√°',
          'r·ªÖ v√† l√° - gi√∫p c√¢y h·∫•p th·ª• dinh d∆∞·ª°ng'
        ],
        c: 0
      },
      {
        type: 'mcq',
        q: '·ªû c√¢y Hai l√° m·∫ßm, m√¥ ph√¢n sinh b√™n ph√¢n b·ªë ..., c√≥ ch·ª©c nƒÉng ...',
        o: [
          '·ªü v√πng ƒë·ªânh c·ªßa th√¢n v√† r·ªÖ t·∫°o th√†nh c√°c m√¥ ph√¢n sinh ng·ªçn - l√†m tƒÉng chi·ªÅu d√†i c·ªßa th√¢n v√† r·ªÖ th√¥ng qua sinh tr∆∞·ªüng chi·ªÅu d·ªçc li√™n t·ª•c',
          'theo h√¨nh tr·ª• v√† h∆∞·ªõng ra ph√≠a ngo√†i c·ªßa th√¢n - l√†m tƒÉng ƒë·ªô d√†y c·ªßa th√¢n, r·ªÖ, c√†nh.',
          '·ªü c√°c m·∫Øt ch·ªìi b√™n v√† ch·ªìi ng·ªçn d·ªçc theo th√¢n - t·∫°o ra c√°c c∆° quan m·ªõi nh∆∞ l√°, hoa, qu·∫£ v√† ph√¢n nh√°nh cho c√¢y',
          'gi·ªØa m√¥ g·ªó v√† m√¥ r√¢y theo chi·ªÅu xuy√™n t√¢m c·ªßa th√¢n - v·∫≠n chuy·ªÉn n∆∞·ªõc, ch·∫•t kho√°ng v√† s·∫£n ph·∫©m quang h·ª£p gi·ªØa c√°c b·ªô ph·∫≠n c·ªßa c√¢y'
        ],
        c: 1
      },
      {
        type: 'mcq',
        q: '·ªû c√¢y Hai l√° m·∫ßm, m√¥ ph√¢n sinh g·ªìm c√≥ g√¨?',
        o: [
          'm√¥ ph√¢n sinh ƒë·ªânh v√† m√¥ ph√¢n sinh l√≥ng',
          'm√¥ ph√¢n sinh ƒë·ªânh v√† m√¥ ph√¢n sinh b√™n',
          'm√¥ ph√¢n sinh ƒë·ªânh v√† m√¥ ph√¢n sinh r·ªÖ',
          'm√¥ ph√¢n sinh b√™n v√† m√¥ ph√¢n sinh l√≥ng'
        ],
        c: 1
      },
      {
        type: 'mcq',
        q: 'Cho c√°c b·ªô ph·∫≠n sau:<br>(1) ƒê·ªânh r·ªÖ<br>(2) Th√¢n<br>(3) Ch·ªìi n√°ch<br>(4) Ch·ªìi ƒë·ªânh<br>(5) Hoa<br>(6) L√°<br>M√¥ ph√¢n sinh ƒë·ªânh kh√¥ng c√≥ ·ªü',
        o: [
          '(1), (2), (3).',
          '(2), (3), (4).',
          '(3), (4), (5).',
          '(2), (5), (6).'
        ],
        c: 3
      },
      {
        type: 'mcq',
        q: 'Ph√°t tri·ªÉn ·ªü sinh v·∫≠t l√†',
        o: [
          'qu√° tr√¨nh tƒÉng l√™n v·ªÅ k√≠ch th∆∞·ªõc v√† kh·ªëi l∆∞·ª£ng c∆° th·ªÉ do s·ª± tƒÉng l√™n v·ªÅ k√≠ch th∆∞·ªõc v√† kh·ªëi l∆∞·ª£ng t·∫ø b√†o.',
          'nh·ªØng bi·∫øn ƒë·ªïi di·ªÖn ra trong v√≤ng ƒë·ªùi c·ªßa m·ªôt c√° th·ªÉ sinh v·∫≠t, bao g·ªìm ba qu√° tr√¨nh li√™n quan m·∫≠t thi·∫øt v·ªõi nhau l√† sinh tr∆∞·ªüng, ph√¢n ho√° t·∫ø b√†o v√† ph√°t sinh h√¨nh th√°i c√°c c∆° quan c·ªßa c∆° th·ªÉ.',
          'qu√° tr√¨nh tƒÉng l√™n v·ªÅ k√≠ch th∆∞·ªõc v√† kh·ªëi l∆∞·ª£ng c∆° th·ªÉ do s·ª± bi·∫øn ƒë·ªïi di·ªÖn ra trong v√≤ng ƒë·ªùi c·ªßa m·ªôt c√° th·ªÉ sinh v·∫≠t.',
          'qu√° tr√¨nh tƒÉng l√™n v·ªÅ k√≠ch th∆∞·ªõc v√† kh·ªëi l∆∞·ª£ng c∆° th·ªÉ, bi·ªÉu hi·ªán ·ªü ba qu√° tr√¨nh li√™n quan m·∫≠t thi·∫øt v·ªõi nhau l√† sinh tr∆∞·ªüng, ph√¢n ho√° t·∫ø b√†o v√† ph√°t sinh h√¨nh th√°i c√°c c∆° quan c·ªßa c∆° th·ªÉ.'
        ],
        c: 1
      },
      {
        type: 'mcq',
        q: '·ªû c√¢y M·ªôt l√° m·∫ßm, m√¥ ph√¢n sinh g·ªìm c√≥',
        o: [
          'm√¥ ph√¢n sinh ƒë·ªânh v√† m√¥ ph√¢n sinh b√™n.',
          'm√¥ ph√¢n sinh l√≥ng v√† m√¥ ph√¢n sinh b√™n.',
          'm√¥ ph√¢n sinh ƒë·ªânh v√† m√¥ ph√¢n sinh l√≥ng.',
          'm√¥ ph√¢n sinh ƒë·ªânh v√† m√¥ ph√¢n sinh r·ªÖ.'
        ],
        c: 2
      },
      {
        type: 'mcq',
        q: 'Lo·∫°i m√¥ ph√¢n sinh kh√¥ng c√≥ ·ªü c√¢y ng√¥ l√†',
        o: [
          'm√¥ ph√¢n sinh ƒë·ªânh r·ªÖ.',
          'm√¥ ph√¢n sinh l√≥ng.',
          'm√¥ ph√¢n sinh b√™n.',
          'm√¥ ph√¢n sinh ƒë·ªânh th√¢n.'
        ],
        c: 2
      },
      {
        type: 'mcq',
        q: 'Lo·∫°i m√¥ ph√¢n sinh kh√¥ng c√≥ ·ªü c√¢y cam l√†',
        o: [
          'm√¥ ph√¢n sinh ƒë·ªânh r·ªÖ.',
          'm√¥ ph√¢n sinh l√≥ng.',
          'm√¥ ph√¢n sinh b√™n.',
          'm√¥ ph√¢n sinh ƒë·ªânh th√¢n.'
        ],
        c: 1
      }
    ]
  }
};

    let currentSubject = null;
    let quizMode = null;
    let quizStarted = false;
    let quizCompleted = false;
    let shuffledQuestions = [];
    let score = 0; // will hold total points (float)

    let userAnswers = []; // for each question:
    // - for mcq: userAnswers[i] = selectedIndex|null
    // - for tf: userAnswers[i] = [true/false|null, true/false|null, ...] (length 4)

    // UI refs
    const subjectScreen = document.getElementById('subjectScreen');
    const modeScreen = document.getElementById('modeScreen');
    const quizScreen = document.getElementById('quizScreen');
    const resultScreen = document.getElementById('resultScreen');

    const backToSubject = document.getElementById('backToSubject');
    const subjectTitle = document.getElementById('subjectTitle');
    const fullModeDesc = document.getElementById('fullModeDesc');

    const startFullBtn = document.getElementById('startFull');
    const startRandomBtn = document.getElementById('startRandom');

    const backHomeBtn = document.getElementById('backHome');
    const btnRestart = document.getElementById('btnRestart');
    const countInfo = document.getElementById('countInfo');
    const scoreInfo = document.getElementById('scoreInfo');
    const progressFill = document.getElementById('progressFill');
    const quizContent = document.getElementById('quizContent');
    const btnSubmit = document.getElementById('btnSubmit');
    const btnNext = document.getElementById('btnNext');

    const resultScoreLarge = document.getElementById('resultScoreLarge');
    const resultPercent = document.getElementById('resultPercent');
    const resultRemark = document.getElementById('resultRemark');
    const resultRestart = document.getElementById('resultRestart');
    const resultHome = document.getElementById('resultHome');

    // helpers
    function shuffleArray(array) {
      const arr = array.slice();
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function shuffleOptionsForMCQ(question) {
      // returns a copy (qObj) with shuffled o and updated c
      if (question.type !== 'mcq') return JSON.parse(JSON.stringify(question));
      const opts = question.o.map((t, idx) => ({ t, idx }));
      const sh = shuffleArray(opts);
      const newQ = {
        type: 'mcq',
        q: question.q,
        o: sh.map(x => x.t),
        c: sh.findIndex(x => x.idx === question.c)
      };
      return newQ;
    }

    // initialize quiz
    function initializeQuiz(mode = 'full') {
      const allQ = subjectData[currentSubject].questions;
      if (mode === 'full') {
        const shuffled = shuffleArray(allQ).map(q => {
          if (q.type === 'mcq') return shuffleOptionsForMCQ(q);
          else return JSON.parse(JSON.stringify(q)); // tf unchanged
        });
        shuffledQuestions = shuffled;
        userAnswers = shuffledQuestions.map(q => q.type === 'mcq' ? null : [null, null, null, null]);
      } else {
        if (allQ.length === 0) {
          alert('Kh√¥ng c√≥ c√¢u h·ªèi.');
          return;
        }
        const q = allQ[Math.floor(Math.random() * allQ.length)];
        shuffledQuestions = (q.type === 'mcq') ? [shuffleOptionsForMCQ(q)] : [JSON.parse(JSON.stringify(q))];
        userAnswers = [ (shuffledQuestions[0].type === 'mcq') ? null : [null,null,null,null] ];
      }
      quizMode = mode;
      quizStarted = true;
      quizCompleted = false;
      score = 0;
      renderQuiz();
    }

    // Render quiz screen
    function renderQuiz() {
      if (!currentSubject) {
        subjectScreen.classList.remove('hidden');
        modeScreen.classList.add('hidden');
        quizScreen.classList.add('hidden');
        resultScreen.classList.add('hidden');
        return;
      }
      if (!quizStarted) {
        subjectScreen.classList.add('hidden');
        modeScreen.classList.remove('hidden');
        quizScreen.classList.add('hidden');
        resultScreen.classList.add('hidden');
        return;
      }
      subjectScreen.classList.add('hidden');
      modeScreen.classList.add('hidden');
      quizScreen.classList.remove('hidden');
      resultScreen.classList.add('hidden');

      // header info
      const totalQuestions = shuffledQuestions.length;
      if (quizMode === 'full') {
        countInfo.textContent = `T·ªïng ${totalQuestions} c√¢u`;
        const answeredCount = shuffledQuestions.reduce((acc, q, i) => {
          if (q.type === 'mcq') return acc + (userAnswers[i] !== null ? 1 : 0);
          else {
            return acc + (userAnswers[i].some(x => x !== null) ? 1 : 0);
          }
        }, 0);
        scoreInfo.textContent = `ƒê√£ tr·∫£ l·ªùi: ${answeredCount}/${totalQuestions}`;
        const pct = Math.round((answeredCount/Math.max(1,totalQuestions))*100);
        progressFill.style.width = pct + '%';
      } else {
        if (shuffledQuestions[0].type === 'mcq') {
          scoreInfo.textContent = `ƒê√£ tr·∫£ l·ªùi: ${userAnswers[0] !== null ? 1 : 0}/1`;
        } else {
          scoreInfo.textContent = `ƒê√£ tr·∫£ l·ªùi: ${userAnswers[0].some(x=>x!==null) ? 1 : 0}/1`;
        }
        progressFill.style.width = '0%';
      }

      // render content
      quizContent.innerHTML = '';
      btnRestart.textContent = (quizMode === 'random') ? 'C√¢u kh√°c' : 'L√†m l·∫°i';

      if (quizMode === 'full') {
        // show all questions
        shuffledQuestions.forEach((q, qi) => {
          const qWrap = document.createElement('div');
          qWrap.className = 'mb-6 pb-4 border-b';

          const qTitle = document.createElement('h3');
          qTitle.className = 'text-lg font-semibold mb-3';
          qTitle.innerHTML = `C√¢u ${qi+1}. ${q.q}`;

          qWrap.appendChild(qTitle);

          if (q.type === 'mcq') {
            const opts = document.createElement('div');
            opts.className = 'space-y-2';
            q.o.forEach((opt, oi) => {
              const btn = document.createElement('button');
              btn.type = 'button';
              btn.className = 'w-full text-left p-3 rounded-lg border-2 border-gray-200 transition-all flex items-center justify-between';
              btn.dataset.qi = qi; btn.dataset.oi = oi;
              btn.innerHTML = `<span class="font-medium text-gray-800">${opt}</span><span class="icon-area"></span>`;

              if (userAnswers[qi] === oi) {
                btn.classList.add('border-blue-500', 'bg-blue-50');
              }

              btn.addEventListener('click', () => {
                if (userAnswers[qi] === oi) {
                  userAnswers[qi] = null;
                  btn.classList.remove('border-blue-500', 'bg-blue-50');
                } else {
                  userAnswers[qi] = oi;
                  opts.querySelectorAll('button').forEach(b => b.classList.remove('border-blue-500', 'bg-blue-50'));
                  btn.classList.add('border-blue-500', 'bg-blue-50');
                }
                const answeredCount = shuffledQuestions.reduce((acc, q2, i2) => {
                  if (q2.type === 'mcq') return acc + (userAnswers[i2] !== null ? 1 : 0);
                  else return acc + (userAnswers[i2].some(x=>x!==null) ? 1 : 0);
                }, 0);
                scoreInfo.textContent = `ƒê√£ tr·∫£ l·ªùi: ${answeredCount}/${shuffledQuestions.length}`;
                setSubmitState(answeredCount > 0, 'N·ªôp b√†i');
              });

              opts.appendChild(btn);
            });
            qWrap.appendChild(opts);
          } else if (q.type === 'tf') {
            const opts = document.createElement('div');
            opts.className = 'space-y-2';
            q.statements.forEach((stmt, sidx) => {
              const row = document.createElement('div');
              row.className = 'flex items-center gap-3';

              const stmtDiv = document.createElement('div');
              stmtDiv.className = 'flex-1 p-3 rounded-lg border border-gray-200';
              stmtDiv.innerHTML = `<div class="font-medium text-gray-800">${stmt}</div>`;

              row.appendChild(stmtDiv);

              const btnTrue = document.createElement('button');
              btnTrue.type = 'button';
              btnTrue.className = 'px-3 py-2 rounded-lg border border-gray-200 mr-2';
              btnTrue.textContent = 'ƒê√öNG';
              const btnFalse = document.createElement('button');
              btnFalse.type = 'button';
              btnFalse.className = 'px-3 py-2 rounded-lg border border-gray-200';
              btnFalse.textContent = 'SAI';

              const val = userAnswers[qi][sidx];
              if (val === true) { btnTrue.classList.add('bg-blue-50','border-blue-500'); }
              else if (val === false) { btnFalse.classList.add('bg-blue-50','border-blue-500'); }

              btnTrue.addEventListener('click', () => {
                if (userAnswers[qi][sidx] === true) {
                  userAnswers[qi][sidx] = null;
                  btnTrue.classList.remove('bg-blue-50','border-blue-500');
                } else {
                  userAnswers[qi][sidx] = true;
                  btnTrue.classList.add('bg-blue-50','border-blue-500');
                  btnFalse.classList.remove('bg-blue-50','border-blue-500');
                }
                const answeredCount = shuffledQuestions.reduce((acc, q2, i2) => {
                  if (q2.type === 'mcq') return acc + (userAnswers[i2] !== null ? 1 : 0);
                  else return acc + (userAnswers[i2].some(x=>x!==null) ? 1 : 0);
                }, 0);
                scoreInfo.textContent = `ƒê√£ tr·∫£ l·ªùi: ${answeredCount}/${shuffledQuestions.length}`;
                setSubmitState(answeredCount > 0, 'N·ªôp b√†i');
              });

              btnFalse.addEventListener('click', () => {
                if (userAnswers[qi][sidx] === false) {
                  userAnswers[qi][sidx] = null;
                  btnFalse.classList.remove('bg-blue-50','border-blue-500');
                } else {
                  userAnswers[qi][sidx] = false;
                  btnFalse.classList.add('bg-blue-50','border-blue-500');
                  btnTrue.classList.remove('bg-blue-50','border-blue-500');
                }
                const answeredCount = shuffledQuestions.reduce((acc, q2, i2) => {
                  if (q2.type === 'mcq') return acc + (userAnswers[i2] !== null ? 1 : 0);
                  else return acc + (userAnswers[i2].some(x=>x!==null) ? 1 : 0);
                }, 0);
                scoreInfo.textContent = `ƒê√£ tr·∫£ l·ªùi: ${answeredCount}/${shuffledQuestions.length}`;
                setSubmitState(answeredCount > 0, 'N·ªôp b√†i');
              });

              const btnWrap = document.createElement('div');
              btnWrap.className = 'flex items-center';
              btnWrap.appendChild(btnTrue);
              btnWrap.appendChild(btnFalse);
              row.appendChild(btnWrap);

              opts.appendChild(row);
            });

            qWrap.appendChild(opts);
          }

          quizContent.appendChild(qWrap);
        });

        const anyAnswered = userAnswers.some(x => (Array.isArray(x) ? x.some(v=>v!==null) : x !== null));
        setSubmitState(anyAnswered, 'N·ªôp b√†i');
        btnNext.classList.add('hidden');

      } else {
        const q = shuffledQuestions[0];
        const qWrap = document.createElement('div');
        qWrap.className = '';

        const qTitle = document.createElement('h3');
        qTitle.className = 'text-2xl font-bold text-gray-800 mb-6';
        qTitle.innerHTML = q.q;
        qWrap.appendChild(qTitle);

        if (q.type === 'mcq') {
          const opts = document.createElement('div');
          opts.className = 'space-y-3 mb-6';
          q.o.forEach((opt, idx) => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'w-full text-left p-4 rounded-lg border-2 border-gray-200 transition-all mb-1 flex items-center justify-between';
            btn.innerHTML = `<span class="font-medium text-gray-800">${opt}</span><span class="icon-area"></span>`;

            if (userAnswers[0] === idx) btn.classList.add('border-blue-500','bg-blue-50');
            btn.addEventListener('click', () => {
              if (userAnswers[0] === idx) { userAnswers[0] = null; btn.classList.remove('border-blue-500','bg-blue-50'); }
              else {
                userAnswers[0] = idx;
                opts.querySelectorAll('button').forEach(b => b.classList.remove('border-blue-500','bg-blue-50'));
                btn.classList.add('border-blue-500','bg-blue-50');
              }
              setSubmitState(userAnswers[0] !== null, 'N·ªôp b√†i');
            });
            opts.appendChild(btn);
          });
          qWrap.appendChild(opts);
          setSubmitState(userAnswers[0] !== null, 'N·ªôp b√†i');
          btnNext.classList.add('hidden');
        } else {
          const opts = document.createElement('div');
          opts.className = 'space-y-3 mb-6';
          q.statements.forEach((stmt, sidx) => {
            const row = document.createElement('div');
            row.className = 'flex items-center gap-3';

            const stmtDiv = document.createElement('div');
            stmtDiv.className = 'flex-1 p-3 rounded-lg border border-gray-200';
            stmtDiv.innerHTML = `<div class="font-medium text-gray-800">${stmt}</div>`;

            row.appendChild(stmtDiv);

            const btnTrue = document.createElement('button');
            btnTrue.type = 'button';
            btnTrue.className = 'px-3 py-2 rounded-lg border border-gray-200 mr-2';
            btnTrue.textContent = 'ƒê√öNG';
            const btnFalse = document.createElement('button');
            btnFalse.type = 'button';
            btnFalse.className = 'px-3 py-2 rounded-lg border border-gray-200';
            btnFalse.textContent = 'SAI';

            const val = userAnswers[0][sidx];
            if (val === true) { btnTrue.classList.add('bg-blue-50','border-blue-500'); }
            else if (val === false) { btnFalse.classList.add('bg-blue-50','border-blue-500'); }

            btnTrue.addEventListener('click', () => {
              if (userAnswers[0][sidx] === true) { userAnswers[0][sidx] = null; btnTrue.classList.remove('bg-blue-50','border-blue-500'); }
              else { userAnswers[0][sidx] = true; btnTrue.classList.add('bg-blue-50','border-blue-500'); btnFalse.classList.remove('bg-blue-50','border-blue-500'); }
              setSubmitState(userAnswers[0].some(x=>x!==null), 'N·ªôp b√†i');
            });
            btnFalse.addEventListener('click', () => {
              if (userAnswers[0][sidx] === false) { userAnswers[0][sidx] = null; btnFalse.classList.remove('bg-blue-50','border-blue-500'); }
              else { userAnswers[0][sidx] = false; btnFalse.classList.add('bg-blue-50','border-blue-500'); btnTrue.classList.remove('bg-blue-50','border-blue-500'); }
              setSubmitState(userAnswers[0].some(x=>x!==null), 'N·ªôp b√†i');
            });

            const btnWrap = document.createElement('div');
            btnWrap.className = 'flex items-center';
            btnWrap.appendChild(btnTrue);
            btnWrap.appendChild(btnFalse);
            row.appendChild(btnWrap);

            opts.appendChild(row);
          });
          qWrap.appendChild(opts);
          setSubmitState(userAnswers[0].some(x=>x!==null), 'N·ªôp b√†i');
          btnNext.classList.add('hidden');
        }

        quizContent.appendChild(qWrap);
      }
    } // renderQuiz end

    // Submit button helper
    function setSubmitState(enabled, text) {
      if (enabled) {
        btnSubmit.disabled = false;
        btnSubmit.classList.remove('cursor-not-allowed','bg-gray-300','text-gray-500');
        btnSubmit.classList.add('bg-blue-600','text-white');
      } else {
        btnSubmit.disabled = true;
        btnSubmit.classList.add('cursor-not-allowed','bg-gray-300','text-gray-500');
        btnSubmit.classList.remove('bg-blue-600','text-white');
      }
      if (text) btnSubmit.textContent = text;
    }

    // grading helper for TF question: counts correct sub-items and maps to points
    function tfPointsForCorrectCount(n) {
      if (n <= 0) return 0;
      if (n === 1) return 0.1;
      if (n === 2) return 0.25;
      if (n === 3) return 0.5;
      if (n === 4) return 1;
      return 0;
    }

    // Submit handler
    btnSubmit.addEventListener('click', () => {
      if (!quizStarted) return;
      if (btnSubmit.disabled && quizCompleted) return;

      const confirmMsg = 'B·∫°n c√≥ ch·∫Øc mu·ªën n·ªôp b√†i? Sau khi n·ªôp s·∫Ω kh√¥ng th·ªÉ thay ƒë·ªïi ƒë√°p √°n.';
      const warningToggle = document.getElementById('warningToggle');
      const warningsEnabled = warningToggle ? warningToggle.checked : true;
      if (warningsEnabled) {
        if (!confirm(confirmMsg)) return;
      }

      if (quizMode === 'full') {
        const anyAnswered = userAnswers.some(x => (Array.isArray(x) ? x.some(v=>v!==null) : x !== null));
        if (!anyAnswered) return;

        let totalPoints = 0;
        let totalPossible = 0;
        shuffledQuestions.forEach((q, i) => {
          if (q.type === 'mcq') {
            totalPossible += 1;
            if (userAnswers[i] === q.c) totalPoints += 1;
          } else if (q.type === 'tf') {
            totalPossible += 1;
            const correctArr = q.answers;
            const userArr = userAnswers[i];
            let correctCount = 0;
            for (let j=0;j<4;j++){
              if (userArr[j] === null) continue;
              if (userArr[j] === correctArr[j]) correctCount++;
            }
            totalPoints += tfPointsForCorrectCount(correctCount);
          }
        });

        score = totalPoints;
        quizCompleted = true;

        quizContent.innerHTML = '';
        const summary = document.createElement('div');
        summary.className = 'mb-6 p-4 rounded-lg border bg-gray-50';
        const pct = Math.round((totalPoints/totalPossible)*100);
        summary.innerHTML = `<div class="text-center"><div class="text-3xl font-bold text-blue-600">${(Math.round(totalPoints*100)/100)}/${totalPossible}</div><div class="text-lg text-gray-600">ƒêi·ªÉm s·ªë: ${pct}%</div></div>`;
        quizContent.appendChild(summary);

        shuffledQuestions.forEach((q, qi) => {
          const qWrap = document.createElement('div');
          qWrap.className = 'mb-6 pb-4 border-b';
          const qTitle = document.createElement('h3');
          qTitle.className = 'text-lg font-semibold mb-3';
          qTitle.innerHTML = `C√¢u ${qi+1}. ${q.q}`;

          qWrap.appendChild(qTitle);

          if (q.type === 'mcq') {
            const opts = document.createElement('div');
            opts.className = 'space-y-2';
            q.o.forEach((opt, oi) => {
              const div = document.createElement('div');
              div.className = 'w-full text-left p-3 rounded-lg border-2 transition-all mb-1 flex items-center justify-between';
              if (oi === q.c) {
                if (userAnswers[qi] === q.c) {
                  div.classList.add('border-green-500','bg-green-50');
                  div.innerHTML = `<span class="font-medium text-gray-800">${opt}</span><span class="text-green-700 font-semibold">ƒê√öNG</span>`;
                } else {
                  div.classList.add('border-gray-200');
                  div.innerHTML = `<span class="font-medium text-gray-800">${opt}</span><span class="text-gray-600">ƒê√°p √°n ƒë√∫ng</span>`;
                }
              } else if (userAnswers[qi] === oi) {
                div.classList.add('border-red-500','bg-red-50');
                div.innerHTML = `<span class="font-medium text-gray-800">${opt}</span><span class="text-red-700 font-semibold">SAI</span>`;
              } else {
                div.classList.add('border-gray-200');
                div.innerHTML = `<span class="font-medium text-gray-800">${opt}</span><span></span>`;
              }
              opts.appendChild(div);
            });
            qWrap.appendChild(opts);
          } else if (q.type === 'tf') {
            const list = document.createElement('div');
            list.className = 'space-y-2';
            q.statements.forEach((stmt, sidx) => {
              const correct = q.answers[sidx];
              const userVal = userAnswers[qi][sidx];
              const div = document.createElement('div');
              div.className = 'w-full text-left p-3 rounded-lg border-2 flex items-center justify-between';
              if (userVal === null) {
                div.classList.add('border-gray-200','bg-gray-50');
                div.innerHTML = `<div><div class="font-medium text-gray-800">${stmt}</div><div class="text-gray-600 text-sm">B·∫°n ch∆∞a ch·ªçn</div></div><div class="text-gray-600">ƒê√°p √°n: ${correct ? 'ƒê√öNG' : 'SAI'}</div>`;
              } else if (userVal === correct) {
                div.classList.add('border-green-500','bg-green-50');
                div.innerHTML = `<div class="font-medium text-gray-800">${stmt}</div><div class="text-green-700 font-semibold">B·∫°n ch·ªçn: ${userVal ? 'ƒê√öNG' : 'SAI'}</div>`;
              } else {
                div.classList.add('border-red-500','bg-red-50');
                div.innerHTML = `<div class="font-medium text-gray-800">${stmt}</div><div class="text-red-700 font-semibold">B·∫°n ch·ªçn: ${userVal ? 'ƒê√öNG' : 'SAI'}</div><div class="text-gray-600 text-sm">ƒê√°p √°n: ${correct ? 'ƒê√öNG' : 'SAI'}</div>`;
              }
              list.appendChild(div);
            });
            let correctCount = 0;
            for (let j=0;j<4;j++) if (userAnswers[qi][j] !== null && userAnswers[qi][j] === q.answers[j]) correctCount++;
            const pts = tfPointsForCorrectCount(correctCount);
            const ptsDiv = document.createElement('div');
            ptsDiv.className = 'mt-2 text-sm text-gray-700 font-semibold';
            ptsDiv.textContent = `ƒêi·ªÉm ƒë·∫°t ƒë∆∞·ª£c cho c√¢u n√†y: ${pts}`;
            qWrap.appendChild(list);
            qWrap.appendChild(ptsDiv);
          }

          quizContent.appendChild(qWrap);
        });

        setSubmitState(false, 'ƒê√£ n·ªôp');
        btnNext.classList.add('hidden');
      } else {
        if (userAnswers[0] === null || (Array.isArray(userAnswers[0]) && !userAnswers[0].some(x=>x!==null))) return;

        const q = shuffledQuestions[0];
        if (q.type === 'mcq') {
          const isCorrect = userAnswers[0] === q.c;
          score = isCorrect ? 1 : 0;
          quizContent.innerHTML = '';
          const qWrap = document.createElement('div');
          const qTitle = document.createElement('h3');
          qTitle.className = 'text-2xl font-bold text-gray-800 mb-6';
          qTitle.innerHTML = q.q;
          qWrap.appendChild(qTitle);
          const opts = document.createElement('div');
          opts.className = 'space-y-3 mb-6';
          q.o.forEach((opt, idx) => {
            const div = document.createElement('div');
            div.className = 'w-full text-left p-4 rounded-lg border-2 transition-all mb-1 flex items-center justify-between';
            if (idx === q.c) {
              div.classList.add('border-green-500','bg-green-50');
              div.innerHTML = `<span class="font-medium text-gray-800">${opt}</span><span class="text-green-700 font-semibold">ƒê√öNG</span>`;
            } else if (userAnswers[0] === idx && idx !== q.c) {
              div.classList.add('border-red-500','bg-red-50');
              div.innerHTML = `<span class="font-medium text-gray-800">${opt}</span><span class="text-red-700 font-semibold">SAI ‚Äî ƒê√°p √°n l√†: ${q.o[q.c]}</span>`;
            } else {
              div.classList.add('border-gray-200');
              div.innerHTML = `<span class="font-medium text-gray-800">${opt}</span><span class="icon-area"></span>`;
            }
            opts.appendChild(div);
          });
          qWrap.appendChild(opts);
          quizContent.appendChild(qWrap);
          quizCompleted = true;
          setSubmitState(false, 'ƒê√£ n·ªôp');
          btnNext.classList.remove('hidden');
        } else {
          const userArr = userAnswers[0];
          let correctCount = 0;
          for (let i=0;i<4;i++) if (userArr[i] !== null && userArr[i] === q.answers[i]) correctCount++;
          const pts = tfPointsForCorrectCount(correctCount);
          score = pts;

          quizContent.innerHTML = '';
          const qWrap = document.createElement('div');
          const qTitle = document.createElement('h3');
          qTitle.className = 'text-2xl font-bold text-gray-800 mb-6';
          qTitle.innerHTML = q.q;
          qWrap.appendChild(qTitle);
          const list = document.createElement('div'); list.className = 'space-y-3 mb-6';
          q.statements.forEach((stmt,sidx) => {
            const div = document.createElement('div');
            div.className = 'w-full text-left p-4 rounded-lg border-2 transition-all mb-1 flex items-center justify-between';
            const correct = q.answers[sidx];
            const userVal = userArr[sidx];
            if (userVal === null) {
              div.classList.add('border-gray-200','bg-gray-50');
              div.innerHTML = `<div class="font-medium text-gray-800">${stmt}</div><div class="text-gray-600">B·∫°n ch∆∞a ch·ªçn ‚Äî ƒê√°p √°n: ${correct ? 'ƒê√öNG' : 'SAI'}</div>`;
            } else if (userVal === correct) {
              div.classList.add('border-green-500','bg-green-50');
              div.innerHTML = `<div class="font-medium text-gray-800">${stmt}</div><div class="text-green-700 font-semibold">B·∫°n ch·ªçn: ${userVal ? 'ƒê√öNG' : 'SAI'}</div>`;
            } else {
              div.classList.add('border-red-500','bg-red-50');
              div.innerHTML = `<div class="font-medium text-gray-800">${stmt}</div><div class="text-red-700 font-semibold">B·∫°n ch·ªçn: ${userVal ? 'ƒê√öNG' : 'SAI'}</div><div class="text-gray-600">ƒê√°p √°n: ${correct ? 'ƒê√öNG' : 'SAI'}</div>`;
            }
            list.appendChild(div);
          });
          qWrap.appendChild(list);
          const ptsDiv = document.createElement('div'); ptsDiv.className = 'text-sm font-semibold'; ptsDiv.textContent = `ƒêi·ªÉm ƒë·∫°t ƒë∆∞·ª£c: ${pts}`;
          qWrap.appendChild(ptsDiv);
          quizContent.appendChild(qWrap);
          quizCompleted = true;
          setSubmitState(false, 'ƒê√£ n·ªôp');
          btnNext.classList.remove('hidden');
        }
      }
    });

    // Next button (random mode)
    btnNext.addEventListener('click', () => {
      if (quizMode === 'random') initializeQuiz('random');
    });

    // Restart / navigation handlers
btnRestart.addEventListener('click', () => {
  if (!currentSubject) return;

  // N·∫øu ƒëang ·ªü ch·∫ø ƒë·ªô random: ngay l·∫≠p t·ª©c l·∫•y c√¢u random kh√°c,
  // KH√îNG h·ªèi confirm d√π toggle c·∫£nh b√°o ƒëang b·∫≠t hay t·∫Øt.
  if (quizMode === 'random') {
    initializeQuiz('random');
    return;
  }

  // Ch·∫ø ƒë·ªô full (c≈©): gi·ªØ h√†nh vi confirm nh∆∞ tr∆∞·ªõc
  if (quizStarted && !quizCompleted) {
    if (!confirm('B·∫°n c√≥ mu·ªën l√†m l·∫°i? M·ªçi c√¢u tr·∫£ l·ªùi hi·ªán t·∫°i s·∫Ω b·ªã m·∫•t.')) return;
  }
  initializeQuiz(quizMode);
});


    resultRestart.addEventListener('click', () => {
      if (!currentSubject) return;
      initializeQuiz(quizMode);
    });

    function navigateHomeWithConfirm() {
      if (quizStarted && !quizCompleted) {
        if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën r·ªùi trang? M·ªçi c√¢u tr·∫£ l·ªùi s·∫Ω kh√¥ng ƒë∆∞·ª£c l∆∞u.')) return false;
      }
      currentSubject = null;
      quizStarted = false;
      renderQuiz();
      return true;
    }

    resultHome.addEventListener('click', () => {
      navigateHomeWithConfirm();
    });

    backHomeBtn.addEventListener('click', () => {
      if (quizStarted && !quizCompleted && document.getElementById('warningToggle') && document.getElementById('warningToggle').checked) {
        const ok = confirm('B·∫°n ƒëang l√†m b√†i, m·ªçi ti·∫øn tr√¨nh s·∫Ω m·∫•t. B·∫°n c√≥ ch·∫Øc kh√¥ng?');
        if (!ok) return;
      }
      quizStarted = false;
      quizCompleted = false;
      currentSubject = null;
      renderQuiz();
    });

    backToSubject.addEventListener('click', () => navigateHomeWithConfirm());

    // selection listeners
    selectOnSinh29126.addEventListener('click', () => {
      currentSubject = 'onsinh29126';
      subjectTitle.textContent = subjectData.onsinh29126.fullName || '√în Sinh 29.1.26';
      fullModeDesc.textContent = `L√†m h·∫øt ${subjectData.onsinh29126.questions ? subjectData.onsinh29126.questions.length : '...'} c√¢u h·ªèi`;
      subjectScreen.classList.add('hidden');
      modeScreen.classList.remove('hidden');
    });

    startFullBtn.addEventListener('click', () => initializeQuiz('full'));
    startRandomBtn.addEventListener('click', () => initializeQuiz('random'));

    // beforeunload warning
    window.addEventListener('beforeunload', (e) => {
      const warningToggle = document.getElementById('warningToggle');
      const warningsEnabled = warningToggle ? warningToggle.checked : true;
      if (!warningsEnabled) return;
      if (!quizStarted || quizCompleted) return;
      e.preventDefault();
      e.returnValue = '';
    });

    // persist warning toggle
    (function initWarningToggle(){
      const wt = document.getElementById('warningToggle');
      let saved = localStorage.getItem('warningsEnabled');
      saved = saved === null ? 'true' : saved;
      wt.checked = saved === 'true';
      wt.addEventListener('change', () => {
        localStorage.setItem('warningsEnabled', wt.checked ? 'true' : 'false');
      });
    })();

    // initial render
    renderQuiz();

  </script>
<!-- Firebase SDK - Di chuy·ªÉn xu·ªëng ƒë√¢y -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<script>
// C·∫•u h√¨nh Firebase
const firebaseConfig = {
  apiKey: "AIzaSyB0cL2gvBQHfz6oxrOVWDOR0h2xb822HDM",
  authDomain: "bruh-68680.firebaseapp.com",
  databaseURL: "https://bruh-68680-default-rtdb.firebaseio.com",
  projectId: "bruh-68680",
  storageBucket: "bruh-68680.firebasestorage.app",
  messagingSenderId: "322108184836",
  appId: "1:322108184836:web:f3a60b8fbd50ac1387d851"
};

// Kh·ªüi t·∫°o Firebase v·ªõi error handling
try {
  firebase.initializeApp(firebaseConfig);
  const database = firebase.database();
  const presenceRef = database.ref('presence');
  console.log('‚úÖ Firebase ƒë√£ kh·ªüi t·∫°o th√†nh c√¥ng');
} catch (error) {
  console.error('‚ùå L·ªói kh·ªüi t·∫°o Firebase:', error);
  console.log('üìå Vui l√≤ng ki·ªÉm tra:');
  console.log('   1. Firebase Database Rules (ph·∫£i allow read/write)');
  console.log('   2. Database URL ƒë√∫ng ch∆∞a');
  console.log('   3. Project ID ƒë√∫ng ch∆∞a');
}

// T·∫°o ID duy nh·∫•t cho TR√åNH DUY·ªÜT
let browserId = localStorage.getItem('browserId');
if (!browserId) {
  browserId = 'browser_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  localStorage.setItem('browserId', browserId);
}

const tabId = 'tab_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
const tabsKey = 'activeTabs_' + browserId;
let activeTabs = JSON.parse(localStorage.getItem(tabsKey) || '[]');
activeTabs.push(tabId);
localStorage.setItem(tabsKey, JSON.stringify(activeTabs));

const myPresenceRef = presenceRef.child(browserId);

// Ch·ªâ set online n·∫øu ƒë√¢y l√† tab ƒë·∫ßu ti√™n
if (activeTabs.length === 1) {
  myPresenceRef.set({
    online: true,
    timestamp: Date.now()
  }).then(() => {
    console.log('‚úÖ ƒê√£ ƒëƒÉng k√Ω online th√†nh c√¥ng');
  }).catch(error => {
    console.error('‚ùå L·ªói khi set presence:', error);
    if (error.code === 'PERMISSION_DENIED') {
      console.error('üö® L·ªñI: Firebase Database Rules ch∆∞a cho ph√©p write!');
      console.log('üìù H∆∞·ªõng d·∫´n s·ª≠a:');
      console.log('   1. V√†o https://console.firebase.google.com');
      console.log('   2. Ch·ªçn project "bruh-68680"');
      console.log('   3. V√†o Realtime Database > Rules');
      console.log('   4. ƒê·ªïi rules th√†nh:');
      console.log('      {');
      console.log('        "rules": {');
      console.log('          ".read": true,');
      console.log('          ".write": true');
      console.log('        }');
      console.log('      }');
      console.log('   5. Nh·∫•n Publish');
    }
  });
}

// ƒê√°nh d·∫•u offline khi r·ªùi trang
myPresenceRef.onDisconnect().remove();

// L·∫Øng nghe s·ªë ng∆∞·ªùi online v·ªõi error handling
presenceRef.on('value', (snapshot) => {
  const onlineUsers = snapshot.numChildren();
  const onlineCountEl = document.getElementById('onlineCount');
  if (onlineCountEl) {
    onlineCountEl.textContent = onlineUsers;
  }
  console.log('üë• S·ªë ng∆∞·ªùi online:', onlineUsers);
}, (error) => {
  console.error('‚ùå L·ªói khi ƒë·ªçc presence data:', error);
  if (error.code === 'PERMISSION_DENIED') {
    console.error('üö® L·ªñI: Firebase Database Rules ch∆∞a cho ph√©p read!');
    console.log('üìù Xem h∆∞·ªõng d·∫´n s·ª≠a l·ªói b√™n tr√™n');
    
    // Hi·ªÉn th·ªã th√¥ng b√°o l·ªói cho user
    const onlineCountEl = document.getElementById('onlineCount');
    if (onlineCountEl) {
      onlineCountEl.textContent = '?';
      onlineCountEl.parentElement.title = 'L·ªói k·∫øt n·ªëi Firebase. Vui l√≤ng ki·ªÉm tra Database Rules.';
    }
  }
});

// Cleanup khi t·∫Øt tab
window.addEventListener('beforeunload', () => {
  // X√≥a tab n√†y kh·ªèi danh s√°ch
  let tabs = JSON.parse(localStorage.getItem(tabsKey) || '[]');
  tabs = tabs.filter(id => id !== tabId);
  localStorage.setItem(tabsKey, JSON.stringify(tabs));
  
  // Ch·ªâ remove presence n·∫øu kh√¥ng c√≤n tab n√†o
  if (tabs.length === 0) {
    myPresenceRef.remove();
    localStorage.removeItem('browserId');
    localStorage.removeItem(tabsKey);
  }
});

// Heartbeat ƒë·ªÉ cleanup c√°c tab zombie
setInterval(() => {
  let tabs = JSON.parse(localStorage.getItem(tabsKey) || '[]');
  // Gi·ªØ tab hi·ªán t·∫°i trong danh s√°ch
  if (!tabs.includes(tabId)) {
    tabs.push(tabId);
    localStorage.setItem(tabsKey, JSON.stringify(tabs));
  }
  
  // C·∫≠p nh·∫≠t timestamp ƒë·ªÉ gi·ªØ k·∫øt n·ªëi
  if (tabs.length > 0) {
    myPresenceRef.set({
      online: true,
      timestamp: Date.now()
    });
  }
}, 1000);

// X·ª≠ l√Ω khi tab b·ªã ·∫©n
document.addEventListener('visibilitychange', () => {
  if (!document.hidden) {
    // Khi quay l·∫°i tab, ƒë·∫£m b·∫£o presence v·∫´n c√≤n
    let tabs = JSON.parse(localStorage.getItem(tabsKey) || '[]');
    if (tabs.length > 0) {
      myPresenceRef.set({
        online: true,
        timestamp: Date.now()
      });
    }
  }
});

// Function ƒë·ªÉ clean up presence data c≈© (ch·ªâ x√≥a data qu√° 1 ph√∫t)
window.cleanupOldPresence = function() {
  presenceRef.once('value', (snapshot) => {
    const now = Date.now();
    const oneMinuteAgo = now - 10000;
    
    snapshot.forEach((childSnapshot) => {
      const data = childSnapshot.val();
      if (data && data.timestamp < oneMinuteAgo) {
        childSnapshot.ref.remove();
        console.log('ƒê√£ x√≥a presence c≈©:', childSnapshot.key);
      }
    });
    
    console.log('‚úÖ ƒê√£ d·ªçn d·∫πp presence data c≈©');
  });
}

// Function reset to√†n b·ªô (CH·ªà d√πng khi c·∫ßn thi·∫øt)
window.resetOnlineCount = function() {
  if (!confirm('‚ö†Ô∏è Thao t√°c n√†y s·∫Ω reset T·∫§T C·∫¢ ng∆∞·ªùi online v·ªÅ 0. B·∫°n c√≥ ch·∫Øc ch·∫Øn?')) {
    return;
  }
  
  firebase.database().ref('presence').remove().then(() => {
    console.log('B∆∞·ªõc 1: ƒê√£ x√≥a to√†n b·ªô presence data.');
    
    setTimeout(() => {
      const browserId = localStorage.getItem('browserId');
      if (browserId) {
        const myPresenceRef = firebase.database().ref('presence').child(browserId);
        myPresenceRef.set({
          online: true,
          timestamp: Date.now()
        }).then(() => {
          console.log('B∆∞·ªõc 2: ƒê√£ ƒëƒÉng k√Ω l·∫°i. S·ªë ng∆∞·ªùi online s·∫Ω hi·ªÉn th·ªã 1 sau v√†i gi√¢y.');
        });
      }
    }, 1000);
  }).catch(error => {
    console.error('L·ªói:', error);
  });
}

// T·ª± ƒë·ªông cleanup presence data c≈© khi t·∫£i trang (thay v√¨ reset to√†n b·ªô)
setTimeout(() => {
  cleanupOldPresence();
}, 2000);

console.log('üí° L·ªánh h·ªØu √≠ch:');
console.log('   - cleanupOldPresence() : X√≥a presence data c≈© h∆°n 1 ph√∫t');
console.log('   - resetOnlineCount() : Reset to√†n b·ªô (c·∫©n th·∫≠n!)');
</script>
<!-- Container ƒë·ªÉ nh√∫ng n·ªôi dung quizls.html -->
<div id="embeddedHistoryWrap" class="fixed inset-0 z-50 bg-white/90 hidden overflow-auto p-6">
  <div class="max-w-5xl mx-auto bg-white rounded-2xl shadow-xl p-6 relative">
    <button id="closeHistoryBtn" class="absolute top-4 right-4 bg-gray-100 px-3 py-2 rounded-lg shadow hover:bg-gray-200">ƒê√≥ng ‚úï</button>
    <div id="embeddedHistory" class="prose"></div>
  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const openHistoryBtn = document.getElementById('openHistoryBtn');
  if (openHistoryBtn) {
    openHistoryBtn.addEventListener('click', () => {
      window.location.href = 'quizls.html';
    });
  }
});
</script>

</body>
</html>
